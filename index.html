<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“š ã„ã„‡çš„è³¼æ›¸ç´€éŒ„ V12.8 Final</title>
    <style>
        /* --- æ‰¿è¥² V12.7 UI æ¨£å¼ --- */
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f8f9fa; padding: 15px; margin: 0; color: #333; }
        .container { max-width: 1400px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h1 { text-align: center; color: #333; font-size: 24px; margin-bottom: 20px; letter-spacing: 1px; }
        
        .form-group { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; padding: 25px; border: 1px solid #eee; border-radius: 12px; background: #fafafa; }
        .form-full { grid-column: 1 / -1; }
        label { display: block; font-size: 13px; font-weight: bold; margin-bottom: 8px; color: #555; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; background: white; }
        
        /* é–å®šæ¬„ä½æ¨£å¼ */
        .locked-field { background-color: #e9ecef !important; cursor: not-allowed; border: 1px solid #ccc; color: #6c757d; }

        .checkbox-container { display: flex; align-items: center; gap: 5px; margin-top: 8px; cursor: pointer; user-select: none; color: #555; font-size: 14px; }
        .checkbox-container input { width: 18px; height: 18px; cursor: pointer; margin: 0; }

        .btn-group-vertical { grid-column: 1 / -1; display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        .btn-version { background-color: #6f42c1; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .btn-save { background-color: #28a745; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold; }
        .btn-update { background-color: #ffc107; color: #333; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold; display: none; }
        .btn-cancel { background-color: #6c757d; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 16px; display: none; }

        .category-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 20px 0; }
        .cat-btn { background: #fff; color: #495057; padding: 8px 20px; border-radius: 20px; font-size: 14px; font-weight: bold; cursor: pointer; border: 1px solid #6c757d; transition: 0.2s; }
        .cat-btn.active { background: #007bff; color: #fff; border-color: #007bff; box-shadow: 0 4px 10px rgba(0,123,255,0.3); }

        .sub-filter-container { display: none; flex-wrap: wrap; gap: 8px; justify-content: center; margin: 10px 0 20px; padding: 15px; background: #f8f9fa; border-radius: 15px; border: 1px solid #eee; }
        .sub-cat-btn { background: #e9ecef; color: #495057; padding: 6px 16px; border-radius: 20px; font-size: 14px; cursor: pointer; border: 1px solid #dee2e6; transition: 0.2s; }
        .sub-cat-btn.active { background: #17a2b8; color: #fff; border-color: #17a2b8; }
        
        .tag-pill { display: inline-block; padding: 4px 12px; border-radius: 15px; font-size: 13px; background: #e2f3f5; color: #0c5460; margin-right: 5px; margin-bottom: 5px; cursor: pointer; border: none; transition: 0.1s; vertical-align: middle; }
        .pill-main { background: #007bff !important; color: white !important; }
        .pill-sub { background: #d4edda !important; color: #155724 !important; }
        .alert-pill { background: #dc3545 !important; color: white !important; font-weight: bold; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; table-layout: fixed; }
        th { background-color: #f8f9fa; color: #666; font-weight: bold; padding: 15px 10px; border-bottom: 2px solid #007bff; text-align: left; }
        td { padding: 15px 10px; border-bottom: 1px solid #eee; vertical-align: middle; }

        .bottom-zone { margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; }
        .btn-home { background: #007bff; color: white; padding: 12px 30px; border-radius: 30px; font-size: 16px; font-weight: bold; border: none; cursor: pointer; box-shadow: 0 4px 10px rgba(0,123,255,0.2); transition: 0.2s; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; margin-left: auto; margin-right: auto; }
        
        .stats-panel { display: flex; flex-wrap: wrap; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 12px; border: 1px solid #eee; justify-content: center; }
        .stats-item { background: white; padding: 8px 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 14px; color: #444; border: 1px solid #fff; }

        @media (max-width: 800px) {
            .form-group { grid-template-columns: 1fr 1fr; }
            table, thead, tbody, th, td, tr { display: block; }
            thead { display: none; }
            .group-row-container { border: 1px solid #ddd; margin-bottom: 25px; border-radius: 12px; background: #fff; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
            td { border: none !important; position: relative; padding: 12px 15px 12px 110px !important; border-bottom: 1px solid #f8f9fa !important; }
            td:before { content: attr(data-label); position: absolute; left: 15px; width: 80px; font-weight: bold; color: #007bff; font-size: 13px; }
            td[data-label="æ“ä½œ"]:before, td[data-label="å‚™è¨»"]:before { content: ""; }
            td[data-label="æ“ä½œ"] { padding-left: 15px !important; text-align: right; background: #fcfcfc; border-bottom: none !important; }
            .notes-box { background: #fcfcfc; padding: 10px; border-radius: 6px; font-size: 13px; color: #555; }
        }

        .pagination { display: flex; justify-content: center; align-items: center; gap: 8px; margin: 30px 0; }
        .page-btn { padding: 8px 16px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 6px; }
        .page-btn.active { background: #007bff; color: white; border-color: #007bff; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: none; justify-content: center; align-items: center; z-index: 9999; }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay">âš™ï¸ æ­£åœ¨è™•ç†ä¸­...</div>

<div class="container">
    <h1>ğŸ“š ã„ã„‡çš„è³¼æ›¸ç´€éŒ„</h1>

    <div class="form-group" id="inputForm">
        <div><label>æ›¸å (å¿…å¡«)</label><input type="text" id="title" placeholder="ä¾‹ï¼šå“ˆåˆ©æ³¢ç‰¹"></div>
        <div><label>ä½œè€… *</label><input type="text" id="author" list="authorList" placeholder="ä¾‹ï¼šJ.K. ç¾…ç³"></div>
        <div><label>ä½œè€…åœ‹ç± *</label><input type="text" id="nationality" list="natList" placeholder="ä¾‹ï¼šè‹±åœ‹"></div>
        <div><label>æ›¸ç±é¡å‹ *</label><input type="text" id="bookCategory" list="catList" placeholder="ä¾‹ï¼šæ¼«ç•«"></div>
        
        <div><label>æ›¸ç±é¡åˆ¥ (é€—è™Ÿéš”é–‹) â‚</label><input type="text" id="subCategory" placeholder="ä¾‹ï¼šæ—¥æœ¬, BL"></div>
        <div><label>è³¼è²·ç‹€æ…‹ *</label>
            <select id="buyStatus">
                <option value="" disabled selected>è«‹é¸æ“‡...</option>
                <option>å·²è²·å®Œ</option><option>æœªè²·å®Œ</option><option>æœªå‡ºå®Œæœªè²·å®Œ</option>
                <option>æœªå‡ºå®Œå·²è²·åˆ°é€²åº¦</option><option>å·²è³¼è²·</option><option>é‡è¤‡è³¼è²·</option>
            </select>
        </div>
        <div><label>å…§æ–‡èªè¨€ *</label><input type="text" id="language" list="langList" placeholder="ä¾‹ï¼šç¹é«”ä¸­æ–‡"></div>
        <div><label>å½¢å¼ (ä¾‹ï¼šå¯¦é«”æ›¸, é›»å­æ›¸)</label><input type="text" id="format" list="formatList" placeholder="å¯å¡«å¤šå€‹"></div>
        
        <div><label>æ›¸ç±ä½ç½® *</label><input type="text" id="ePlatform" list="platformList" placeholder="ä¾‹ï¼šBW"></div>
        <div id="divVol">
            <label>ç›®å‰è³¼è²·é›†æ•¸</label>
            <input type="number" id="volume" value="1">
            <label class="checkbox-container">
                <input type="checkbox" id="isSingleVolume" onchange="handleSingleVolume(this)">
                <span>æ­¤æ›¸å…¨ä¸€é›†å®Œçµ</span>
            </label>
        </div>
        <div><label>ä½œå“ç‹€æ…‹ *</label><input type="text" id="workStatus" list="workStatusList" placeholder="ä¾‹ï¼šæ­£æ–‡å®Œçµ"></div>
        <div><label>é–±è®€ç‹€æ…‹ *</label><input type="text" id="readProgress" list="readList" placeholder="ä¾‹ï¼šæœªè®€"></div>
        
        <div class="form-full"><label>æ¨™ç±¤ (é€—è™Ÿéš”é–‹) â‚</label><input type="text" id="tags" placeholder="ä¾‹ï¼šæ¨ç†"></div>
        <div class="form-full"><label>é—œè¯ ID *</label><input type="text" id="relationId" placeholder="ä¾‹ï¼šHP"></div>
        <div class="form-full"><label>å‚™è¨»</label><textarea id="notes" rows="2" placeholder="è©³ç´°å‚™è¨»..."></textarea></div>
        
        <div class="btn-group-vertical">
            <button class="btn-version" id="multiVersionBtn" onclick="toggleMultiVersion()">ï¼‹ ç‚ºæœ¬æ›¸æ–°å¢å…¶ä»–ç‰ˆæœ¬è³‡æ–™</button>
            <button class="btn-save" id="saveBtn" onclick="checkAndSave('save')">å„²å­˜æ›¸å–®è‡³é›²ç«¯</button>
            <button class="btn-update" id="updateBtn" onclick="checkAndSave('update')">æ›´æ–°æ­¤ç‰ˆæœ¬è³‡è¨Š</button>
            <button class="btn-cancel" id="cancelBtn" onclick="resetForm()">å–æ¶ˆ/çµæŸé–å®šç‹€æ…‹</button>
        </div>
    </div>

    <datalist id="authorList"></datalist>
    <datalist id="natList"></datalist>
    <datalist id="catList"></datalist>
    <datalist id="langList"></datalist>
    <datalist id="formatList"></datalist>
    <datalist id="platformList"></datalist>
    <datalist id="workStatusList"></datalist>
    <datalist id="readList"></datalist>

    <div id="categoryPanel" class="category-container"></div>
    <div id="subFilterPanel" class="sub-filter-container"></div>

    <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹ç›®å‰æ›¸åº«ä¸­çš„é—œéµå­—..." oninput="handleSearch()" style="width:100%; padding:12px; border-radius:25px; border:2px solid #007bff; margin-bottom:20px;">

    <div id="contentSection" style="display: none;">
        <table id="bookTable">
            <thead>
                <tr><th style="width:120px;">æ“ä½œ</th><th style="width:130px;">æ›¸å/ä½œè€…</th><th style="width:90px;">é–±è®€ç‹€æ…‹</th><th style="width:120px;">æ›¸ç±ä½ç½®</th><th style="width:120px;">å½¢å¼</th><th style="width:130px;">è³¼è²·ç‹€æ³</th><th style="width:150px;">æ¨™ç±¤</th><th>å‚™è¨»</th></tr>
            </thead>
            <tbody id="bookTableBody"></tbody>
        </table>
        <div id="pagination" class="pagination"></div>
    </div>

    <div class="bottom-zone">
        <button class="btn-home" onclick="clearFilter()">ğŸ  å›é¦–é  (éš±è—è¡¨æ ¼)</button>
        <div id="statsPanel" class="stats-panel"></div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbw3MN10RIbddtC_M9Z6zLaP608ZpFDsjKE7Od4s4uSQA5HIEBHH22gTYFkN8pOaTsZO/exec";
    let allBooks = [], currentFilteredGroups = [], currentPage = 1, itemsPerPage = 10;
    let currentFilter = { key: null, value: null }, secondFilter = null;
    let editingTarget = null; // ç´€éŒ„æ­£åœ¨ç·¨è¼¯çš„åŸå§‹è³‡æ–™ç´¢å¼•

    function getPillClass(text, isMain = false) {
        if (!text) return 'tag-pill';
        const alertKeywords = ['æœª', 'æ²’', 'é‡è¤‡', 'ç¼º', 'ä¸'];
        if (alertKeywords.some(k => text.includes(k))) return 'tag-pill alert-pill';
        return isMain ? 'tag-pill pill-main' : 'tag-pill';
    }

    async function loadFromCloud() {
        document.getElementById('loading').style.display='flex';
        try {
            const r = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'read' }) });
            const data = await r.json();
            allBooks = data.map(row => ({
                buyStatus: row[0], title: row[1], author: row[2], language: row[3], bookCategory: row[4], subCategory: row[5],
                format: row[6] ? row[6].split(',').map(s=>s.trim()) : [],
                ePlatform: row[7], volume: row[8], workStatus: row[9], readProgress: row[10],
                tags: row[11] ? row[11].split(',').map(s=>s.trim()) : [],
                relationId: row[12], notes: row[13], nationality: row[14] || ''
            }));
            updateDatalists();
            updateCategoryButtons();
            updateStats();
        } catch (e) { console.error(e); }
        document.getElementById('loading').style.display='none';
    }

    /* --- ä¿®å¾©æ ¸å¿ƒï¼šå„²å­˜ã€æ›´æ–°èˆ‡æ–°å¢ç‰ˆæœ¬é‚è¼¯ --- */
    async function checkAndSave(mode) {
        const title = document.getElementById('title').value;
        if (!title) { alert("æ›¸åç‚ºå¿…å¡«ï¼"); return; }
        
        document.getElementById('loading').style.display='flex';
        const bookData = {
            action: mode === 'update' ? 'save' : 'save', // å¾Œå°é€šå¸¸å…±ç”¨ save é‚è¼¯ï¼Œä½†éœ€å‚³å…¥è­˜åˆ¥è³‡æ–™
            oldTitle: editingTarget ? editingTarget.title : null,
            oldLang: editingTarget ? editingTarget.language : null,
            oldFormat: editingTarget ? editingTarget.format.join(',') : null,
            buyStatus: document.getElementById('buyStatus').value,
            title: title,
            author: document.getElementById('author').value,
            nationality: document.getElementById('nationality').value,
            language: document.getElementById('language').value,
            bookCategory: document.getElementById('bookCategory').value,
            subCategory: document.getElementById('subCategory').value,
            format: document.getElementById('format').value,
            ePlatform: document.getElementById('ePlatform').value,
            volume: document.getElementById('isSingleVolume').checked ? "1(å…¨)" : document.getElementById('volume').value,
            workStatus: document.getElementById('workStatus').value,
            readProgress: document.getElementById('readProgress').value,
            tags: document.getElementById('tags').value,
            relationId: document.getElementById('relationId').value,
            notes: document.getElementById('notes').value
        };

        try {
            await fetch(API_URL, { method: 'POST', body: JSON.stringify(bookData) });
            resetForm();
            await loadFromCloud();
            alert(mode === 'update' ? "æ›´æ–°æˆåŠŸï¼" : "å„²å­˜æˆåŠŸï¼");
        } catch (e) { alert("æ“ä½œå¤±æ•—"); }
        document.getElementById('loading').style.display='none';
    }

    function editBook(t, l, f) {
        const book = allBooks.find(b => b.title === t && b.language === l && b.format.join(',') === f);
        if (!book) return;
        editingTarget = book; // ç´€éŒ„åŸå§‹ç´¢å¼•
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        // å¡«å……æ¬„ä½
        document.getElementById('title').value = book.title;
        document.getElementById('author').value = book.author;
        document.getElementById('nationality').value = book.nationality;
        document.getElementById('bookCategory').value = book.bookCategory;
        document.getElementById('subCategory').value = book.subCategory;
        document.getElementById('buyStatus').value = book.buyStatus;
        document.getElementById('language').value = book.language;
        document.getElementById('format').value = book.format.join(', ');
        document.getElementById('ePlatform').value = book.ePlatform;
        document.getElementById('volume').value = parseInt(book.volume) || 1;
        document.getElementById('isSingleVolume').checked = book.volume.toString().includes('å…¨');
        document.getElementById('workStatus').value = book.workStatus;
        document.getElementById('readProgress').value = book.readProgress;
        document.getElementById('tags').value = book.tags.join(', ');
        document.getElementById('relationId').value = book.relationId;
        document.getElementById('notes').value = book.notes;
        
        // UI åˆ‡æ›è‡³ç·¨è¼¯æ¨¡å¼
        document.getElementById('saveBtn').style.display = 'none';
        document.getElementById('updateBtn').style.display = 'block';
        document.getElementById('cancelBtn').style.display = 'block';
        document.getElementById('multiVersionBtn').style.display = 'block';
    }

    function toggleMultiVersion() {
        if (!editingTarget) { alert("è«‹å…ˆé»æ“Šä¸‹æ–¹æ›¸ç±çš„ã€ä¿®æ”¹ã€æŒ‰éˆ•ï¼Œå†ä½¿ç”¨æ–°å¢ç‰ˆæœ¬åŠŸèƒ½ã€‚"); return; }
        // é€²å…¥ã€Œæ–°å¢ç‰ˆæœ¬ã€ç‹€æ…‹ï¼šä¿ç•™é—œéµæ¬„ä½ä¸¦é–å®šï¼Œä½†æŒ‰éˆ•è®Šå›å„²å­˜
        const lockFields = ['title', 'author', 'nationality', 'bookCategory', 'relationId'];
        lockFields.forEach(id => document.getElementById(id).classList.add('locked-field'));
        
        document.getElementById('saveBtn').style.display = 'block';
        document.getElementById('saveBtn').innerText = "å„²å­˜ç‚ºæ–°ç‰ˆæœ¬";
        document.getElementById('updateBtn').style.display = 'none';
        editingTarget = null; // æ¸…é™¤ç·¨è¼¯ç›®æ¨™ï¼Œè®“å„²å­˜é‚è¼¯èµ°ã€Œæ–°å¢ã€è€Œéã€Œè¦†è“‹ã€
    }

    function resetForm() {
        document.getElementById('inputForm').querySelectorAll('input, select, textarea').forEach(el => {
            el.value = '';
            el.classList.remove('locked-field');
        });
        document.getElementById('isSingleVolume').checked = false;
        document.getElementById('saveBtn').style.display = 'block';
        document.getElementById('saveBtn').innerText = "å„²å­˜æ›¸å–®è‡³é›²ç«¯";
        document.getElementById('updateBtn').style.display = 'none';
        document.getElementById('cancelBtn').style.display = 'none';
        editingTarget = null;
    }

    /* --- å…¶é¤˜ V12.7 ç¯©é¸ã€çµ±è¨ˆèˆ‡ UI é‚è¼¯ --- */
    function updateDatalists() {
        const getUnique = (key) => [...new Set(allBooks.map(b => b[key]))].filter(v => v && v !== '-');
        const fill = (id, list) => {
            const el = document.getElementById(id);
            if (el) el.innerHTML = list.sort().map(v => `<option value="${v}">`).join('');
        };
        fill('authorList', getUnique('author'));
        fill('natList', getUnique('nationality'));
        fill('catList', getUnique('bookCategory'));
        fill('langList', getUnique('language'));
        fill('platformList', getUnique('ePlatform'));
        fill('workStatusList', getUnique('workStatus'));
        fill('readList', getUnique('readProgress'));
    }

    function applyFilters(isManual = true) {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        let filtered = allBooks;
        if (!currentFilter.key && !searchTerm && !isManual) { document.getElementById('contentSection').style.display = 'none'; updateStats(); return; }
        if (currentFilter.key === 'é¡å‹') filtered = allBooks.filter(b => b.bookCategory === currentFilter.value);
        if (currentFilter.key === 'ä½œè€…') filtered = allBooks.filter(b => b.author === currentFilter.value);
        if (currentFilter.key === 'ä½ç½®') filtered = allBooks.filter(b => b.ePlatform === currentFilter.value);
        if (currentFilter.key === 'å½¢å¼') filtered = allBooks.filter(b => b.format.includes(currentFilter.value));
        if (currentFilter.key === 'è³¼è²·ç‹€æ…‹') filtered = allBooks.filter(b => b.buyStatus === currentFilter.value);
        if (currentFilter.key === 'é–±è®€ç‹€æ…‹') filtered = allBooks.filter(b => b.readProgress === currentFilter.value);
        if (currentFilter.key === 'å°æ¨™ç±¤') {
            filtered = allBooks.filter(b => {
                const tags = [...(b.subCategory ? b.subCategory.split(/[ï¼Œ,]/).map(s=>s.trim()) : []), ...b.tags];
                return tags.includes(currentFilter.value);
            });
        }
        if (secondFilter) {
            filtered = filtered.filter(b => {
                const tagSet = new Set([...(b.subCategory ? b.subCategory.split(/[ï¼Œ,]/).map(s=>s.trim()) : []), ...b.tags]);
                return tagSet.has(secondFilter);
            });
        }
        if (searchTerm) filtered = filtered.filter(b => b.title.toLowerCase().includes(searchTerm) || b.author.toLowerCase().includes(searchTerm) || b.notes.toLowerCase().includes(searchTerm));

        const groups = [];
        filtered.forEach(b => {
            const k = b.title + "_" + b.author;
            let g = groups.find(x => x.key === k);
            if (!g) { g = { key: k, books: [] }; groups.push(g); }
            g.books.push(b);
        });
        currentFilteredGroups = groups;
        document.getElementById('contentSection').style.display = 'block';
        renderTable();
        updateCategoryButtons();
        updateSubFilterButtons();
        updateStats(); 
    }

    function updateStats() {
        const p = document.getElementById('statsPanel');
        if (!p || allBooks.length === 0) return;
        const fc = {}; allBooks.forEach(b => b.format.forEach(f => fc[f] = (fc[f] || 0) + 1));
        let formatStr = ""; for (let f in fc) formatStr += `${f}(${fc[f]}) `;
        const cc = {}; allBooks.forEach(b => cc[b.bookCategory] = (cc[b.bookCategory] || 0) + 1);
        let catStr = ""; const sortedCats = Object.keys(cc).sort();
        sortedCats.forEach(c => catStr += `${c}(${cc[c]}) `);
        p.innerHTML = `<div class="stats-item">ç¸½åœ–æ›¸é‡ï¼š<strong>${allBooks.length}</strong> æœ¬</div><div class="stats-item">å½¢å¼çµ±è¨ˆï¼š<strong>${formatStr.trim()}</strong></div><div class="stats-item">æ›¸ç±é¡å‹çµ±è¨ˆï¼š<strong>${catStr.trim()}</strong></div>`;
    }

    function renderTable() {
        const tbody = document.getElementById('bookTableBody');
        tbody.innerHTML = '';
        const start = (currentPage - 1) * itemsPerPage;
        const pageGroups = currentFilteredGroups.slice(start, start + itemsPerPage);
        pageGroups.forEach(group => {
            let groupHtml = `<div class="group-row-container">`;
            group.books.forEach((book, idx) => {
                const isFirst = idx === 0;
                const authorFull = book.nationality ? `${book.author} (${book.nationality})` : book.author;
                const params = `'${book.title.replace(/'/g, "\\'")}', '${book.language}', '${book.format.join(',')}'`;
                groupHtml += `<tr><td data-label="æ“ä½œ"><button style="background:#28a745; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;" onclick="editBook(${params})">ä¿®æ”¹</button><button style="background:#dc3545; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; margin-left:4px;" onclick="deleteBook(${params})">åˆªé™¤</button></td><td data-label="æ›¸å/ä½œè€…"><strong style="color:#28a745; cursor:pointer" onclick="editBook(${params})">${book.title}</strong><br><small style="color:#007bff; cursor:pointer;" onclick="setFilter('ä½œè€…','${book.author}')">${authorFull}</small></td><td data-label="é–±è®€ç‹€æ…‹"><span class="${getPillClass(book.readProgress)}" onclick="setFilter('é–±è®€ç‹€æ…‹','${book.readProgress}')">${book.readProgress}</span></td><td data-label="æ›¸ç±ä½ç½®"><span class="tag-pill" style="background:#e9ecef;" onclick="setFilter('ä½ç½®','${book.ePlatform}')">${book.ePlatform}</span></td><td data-label="å½¢å¼"><div>${book.language}</div>${book.format.map(f => `<span class="tag-pill" onclick="setFilter('å½¢å¼','${f}')">${f}</span>`).join('')}</td><td data-label="è³¼è²·ç‹€æ³"><div>${book.volume} ${book.workStatus}</div><span class="${getPillClass(book.buyStatus)}" onclick="setFilter('è³¼è²·ç‹€æ…‹','${book.buyStatus}')">(${book.buyStatus})</span></td>`;
                if (isFirst) {
                    groupHtml += `<td data-label="æ¨™ç±¤"><span class="${getPillClass(book.bookCategory, true)}" onclick="setFilter('é¡å‹','${book.bookCategory}')">${book.bookCategory}</span>${book.tags.map(t => `<span class="tag-pill pill-sub" onclick="setFilter('å°æ¨™ç±¤','${t}')">${t}</span>`).join('')}</td><td data-label="å‚™è¨»">${book.notes ? `<div class="notes-box">${book.notes}</div>` : '-'}</td>`;
                } else { groupHtml += `<td class="pc-only"></td><td class="pc-only"></td>`; }
                groupHtml += `</tr>`;
            });
            groupHtml += `</div>`;
            tbody.innerHTML += groupHtml;
        });
        renderPagination();
    }

    function clearFilter() { currentFilter = { key: null, value: null }; secondFilter = null; document.getElementById('contentSection').style.display = 'none'; document.getElementById('searchInput').value = ''; updateCategoryButtons(); updateSubFilterButtons(); updateStats(); window.scrollTo({ top: 0, behavior: 'smooth' }); }
    function setFilter(key, value) { if (key === 'ä½œè€…') { document.getElementById('searchInput').value = value; applyFilters(true); return; } if (key === 'SHOW_ALL') { currentFilter = { key: null, value: null }; applyFilters(true); return; } currentFilter = { key, value }; secondFilter = null; currentPage = 1; applyFilters(true); }
    function updateCategoryButtons() { const p = document.getElementById('categoryPanel'); const cats = [...new Set(allBooks.map(b => b.bookCategory))].sort(); p.innerHTML = `<button class="cat-btn ${!currentFilter.key ? 'active' : ''}" onclick="setFilter('SHOW_ALL', null)">ğŸ“‚ é¡¯ç¤ºå…¨éƒ¨</button>`; cats.forEach(c => { p.innerHTML += `<button class="cat-btn ${currentFilter.value === c ? 'active' : ''}" onclick="setFilter('é¡å‹','${c}')">${c}</button>`; }); }
    function updateSubFilterButtons() { const panel = document.getElementById('subFilterPanel'); if (currentFilter.key !== 'é¡å‹') { panel.style.display = 'none'; return; } let tags = new Set(); allBooks.filter(b => b.bookCategory === currentFilter.value).forEach(b => { if (b.subCategory) b.subCategory.split(/[ï¼Œ,]/).forEach(s => tags.add(s.trim())); if (b.tags) b.tags.forEach(t => tags.add(t.trim())); }); const sortedTags = Array.from(tags).filter(Boolean).sort(); if (sortedTags.length === 0) { panel.style.display = 'none'; return; } panel.style.display = 'flex'; panel.innerHTML = '<div style="font-size:13px; color:#888; width:100%; text-align:center; margin-bottom:10px;">é€²éšç¯©é¸æ¨™ç±¤ï¼š</div>'; sortedTags.forEach(t => { const btn = document.createElement('button'); btn.className = 'sub-cat-btn' + (secondFilter === t ? ' active' : ''); btn.innerText = t; btn.onclick = () => { secondFilter = (secondFilter === t) ? null : t; applyFilters(true); }; panel.appendChild(btn); }); }
    function renderPagination() { const totalPages = Math.ceil(currentFilteredGroups.length / itemsPerPage); const container = document.getElementById('pagination'); container.innerHTML = ''; if (totalPages <= 1) return; for (let i = 1; i <= totalPages; i++) { const btn = document.createElement('button'); btn.innerText = i; btn.className = `page-btn ${i === currentPage ? 'active' : ''}`; btn.onclick = () => { currentPage = i; renderTable(); window.scrollTo({ top: document.getElementById('contentSection').offsetTop - 50, behavior: 'smooth' }); }; container.appendChild(btn); } }
    function handleSingleVolume(cb) { const v = document.getElementById('volume'); v.disabled = cb.checked; if (cb.checked) v.value = 1; }
    async function deleteBook(t, l, f) { if (!confirm(`ç¢ºå®šåˆªé™¤ï¼Ÿ`)) return; document.getElementById('loading').style.display='flex'; try { await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', title: t, language: l, format: f }) }); await loadFromCloud(); } catch (e) { alert("åˆªé™¤å¤±æ•—"); } document.getElementById('loading').style.display='none'; }
    function handleSearch() { currentPage = 1; applyFilters(true); }
    loadFromCloud();
</script>

</body>
</html>
