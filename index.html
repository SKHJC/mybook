<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„é›²ç«¯æ›¸åº« V5.1 - å‚™ä»½å®‰å…¨ç‰ˆ</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f0f2f5; padding: 15px; margin: 0; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; font-size: 24px; margin-bottom: 10px; }
        
        /* å‚™ä»½æŒ‰éˆ•å€ */
        .backup-zone { text-align: right; margin-bottom: 10px; }
        .btn-secondary { background:#6c757d; color:white; padding:6px 12px; border:none; border-radius:4px; cursor:pointer; font-size: 12px; margin-left: 5px; }
        
        .search-section { margin-bottom: 20px; }
        #searchInput { width: 100%; border: 2px solid #007bff; padding: 12px; border-radius: 25px; box-sizing: border-box; font-size: 16px; }

        .form-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: 8px; background: #fafafa; }
        .form-full { grid-column: 1 / -1; }
        label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 5px; color: #555; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
        
        .btn-add { grid-column: 1 / -1; padding: 12px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 5px; }
        
        .filter-info { background: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 10px; display: none; justify-content: space-between; align-items: center; border: 1px solid #ffeeba; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); display: none; justify-content: center; align-items: center; z-index: 999; font-weight: bold; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
        th, td { border-bottom: 1px solid #eee; padding: 10px; text-align: left; }
        th { background-color: #f8f9fa; }
        
        .clickable { color: #007bff; cursor: pointer; text-decoration: underline; }
        .tag-pill { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; background: #e9ecef; margin-right: 4px; cursor: pointer; border: 1px solid #ccc; }
        .note-text { font-size: 11px; color: #666; font-style: italic; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        @media (max-width: 600px) {
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { border: 1px solid #ccc; margin-bottom: 10px; border-radius: 8px; padding: 10px; }
            td { border: none; position: relative; padding-left: 40%; margin-bottom: 5px; }
            td:before { position: absolute; left: 10px; width: 35%; font-weight: bold; content: attr(data-label); color: #888; }
        }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay">â˜ï¸ åŒæ­¥ä¸­ï¼Œè«‹å‹¿é—œé–‰è¦–çª—...</div>

<div class="container">
    <h1>ğŸ“š ç§äººé›²ç«¯åœ–æ›¸é¤¨</h1>

    <div class="backup-zone">
        <button class="btn-secondary" onclick="exportBackup()">ğŸ’¾ åŒ¯å‡º JSON å‚™ä»½</button>
        <button class="btn-secondary" onclick="document.getElementById('importFile').click()">ğŸ“¤ åŒ¯å…¥å‚™ä»½æª”</button>
        <input type="file" id="importFile" style="display:none" onchange="importBackup(event)">
    </div>
    
    <div class="search-section">
        <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹æ›¸åã€ä½œè€…ã€æ¨™ç±¤ã€å¹³å°æˆ–å‚™è¨»..." oninput="renderTable()">
    </div>

    <div class="form-group">
        <div><label>è³¼è²·ç‹€æ…‹</label><select id="buyStatus"><option>å·²è²·å®Œ</option><option>æœªè²·å®Œ</option><option>æœªå‡ºå®Œæœªè²·å®Œ</option><option>æœªå‡ºå®Œå·²è²·åˆ°é€²åº¦</option></select></div>
        <div><label>æ›¸å (å¿…å¡«)</label><input type="text" id="title"></div>
        <div><label>ä½œè€…</label><input list="authorList" id="author"><datalist id="authorList"></datalist></div>
        <div><label>å…§æ–‡èªè¨€</label><input list="langList" id="language"><datalist id="langList"></datalist></div>
        <div><label>æ›¸ç±é¡å‹</label><input list="catList" id="bookCategory"><datalist id="catList"></datalist></div>
        <div><label>å½¢å¼</label><select id="format" onchange="toggleEPlatform()"><option value="å¯¦é«”æ›¸">å¯¦é«”æ›¸</option><option value="é›»å­æ›¸">é›»å­æ›¸</option></select></div>
        
        <div id="ePlatformDiv" style="display:none;"><label>é›»å­æ›¸å¹³å° (å¿…å¡«)</label><input list="platList" id="ePlatform"><datalist id="platList"></datalist></div>
        
        <div><label>é›†æ•¸</label><input type="number" id="volume" value="1"></div>
        <div><label>ä½œå“ç‹€æ…‹</label><select id="workStatus"><option>æ­£æ–‡å®Œçµ</option><option>æ­£æ–‡æœªå®Œçµ</option><option>ç•ªå¤–å®Œçµ</option><option>ç•ªå¤–æœªå®Œçµ</option><option>å‘</option></select></div>
        <div><label>é–±è®€ç‹€æ…‹</label><input type="text" id="readProgress"></div>
        <div><label>æ¨™ç±¤ (é€—è™Ÿéš”é–‹)</label><input type="text" id="tags"></div>
        <div><label>é—œè¯ ID</label><input type="text" id="relationId"></div>
        <div class="form-full"><label>å‚™è¨»</label><textarea id="notes" rows="1"></textarea></div>
        
        <button class="btn-add" onclick="checkAndSave()">å„²å­˜æ›¸å–®</button>
    </div>

    <div id="filterInfo" class="filter-info">
        <span id="filterText"></span>
        <button onclick="clearFilter()">æ¸…é™¤ç¯©é¸</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>è³¼è²·</th>
                <th>æ›¸å/ä½œè€…</th>
                <th>è¦æ ¼/èªè¨€</th>
                <th>å¹³å°/å‚™è¨»</th>
                <th>é¡å‹/æ¨™ç±¤</th>
                <th>é—œè¯ID</th>
            </tr>
        </thead>
        <tbody id="bookTableBody"></tbody>
    </table>
</div>

<script>
    // âš ï¸ å‹™å¿…æ›æˆä½ éƒ¨ç½²å¾Œçš„ç¶²é æ‡‰ç”¨ç¨‹å¼ URL
    const API_URL = "ä½ çš„_GOOGLE_APPS_SCRIPT_URL"; 
    
    let allBooks = []; 
    let currentFilter = { key: null, value: null };

    function toggleEPlatform() {
        const format = document.getElementById('format').value;
        document.getElementById('ePlatformDiv').style.display = (format === 'é›»å­æ›¸') ? 'block' : 'none';
    }

    // æª¢æŸ¥é‡è¤‡æ›¸å (é˜²å‘†)
    function checkAndSave() {
        const title = document.getElementById('title').value;
        const language = document.getElementById('language').value || 'æœªåˆ†é¡';
        if (!title) return alert("æ›¸åå¿…å¡«ï¼");

        if (document.getElementById('format').value === 'é›»å­æ›¸' && !document.getElementById('ePlatform').value) {
            return alert("è«‹è¼¸å…¥é›»å­æ›¸å¹³å°åç¨±ï¼");
        }

        const isDuplicate = allBooks.some(b => b.title === title && b.language === language);
        if (isDuplicate) {
            if (!confirm(`âš ï¸ æ›¸åº«ä¸­å·²å­˜åœ¨ã€Š${title}ã€‹(${language}ç‰ˆ)ã€‚\nç¢ºå®šè¦è¦†è“‹ç¾æœ‰çš„è³‡æ–™å—ï¼Ÿ`)) return;
        }
        saveToCloud();
    }

    async function saveToCloud() {
        showLoading(true);
        const bookData = {
            action: 'save',
            buyStatus: document.getElementById('buyStatus').value,
            title: document.getElementById('title').value,
            author: document.getElementById('author').value || 'æœªçŸ¥',
            language: document.getElementById('language').value || 'æœªåˆ†é¡',
            bookCategory: document.getElementById('bookCategory').value || 'æœªåˆ†é¡',
            format: document.getElementById('format').value,
            ePlatform: document.getElementById('ePlatform').value || '-',
            volume: document.getElementById('volume').value,
            workStatus: document.getElementById('workStatus').value,
            readProgress: document.getElementById('readProgress').value || 'ç„¡',
            tags: document.getElementById('tags').value,
            relationId: document.getElementById('relationId').value || '-',
            notes: document.getElementById('notes').value || ''
        };

        try {
            await fetch(API_URL, { method: 'POST', body: JSON.stringify(bookData) });
            alert("âœ… åŒæ­¥æˆåŠŸï¼");
            loadFromCloud();
        } catch (e) { alert("âŒ å¤±æ•—ï¼š" + e); }
        showLoading(false);
    }

    async function loadFromCloud() {
        showLoading(true);
        try {
            const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'read' }) });
            const data = await response.json();
            allBooks = data.map(row => ({
                buyStatus: row[0], title: row[1], author: row[2], language: row[3], bookCategory: row[4],
                format: row[5], ePlatform: row[6], volume: row[7], workStatus: row[8], readProgress: row[9],
                tags: typeof row[10] === 'string' ? row[10].split(',').map(s=>s.trim()).filter(Boolean) : [],
                relationId: row[11], notes: row[12]
            }));
            updateDatalists();
            renderTable();
        } catch (e) { console.error(e); }
        showLoading(false);
    }

    // --- å‚™ä»½åŠŸèƒ½ ---
    function exportBackup() {
        if (allBooks.length === 0) return alert("æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º");
        const dataStr = JSON.stringify(allBooks, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `æ›¸åº«å‚™ä»½_${new Date().toISOString().slice(0,10)}.json`;
        link.click();
    }

    function importBackup(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                if (confirm(`æº–å‚™åŒ¯å…¥ ${importedData.length} ç­†è³‡æ–™åˆ°é›²ç«¯ï¼Ÿ`)) {
                    showLoading(true);
                    for (const book of importedData) {
                        book.action = 'save';
                        // è½‰æ› tag é™£åˆ—å›å­—ä¸²ä»¥ç¬¦åˆ save é‚è¼¯
                        book.tags = Array.isArray(book.tags) ? book.tags.join(',') : book.tags;
                        await fetch(API_URL, { method: 'POST', body: JSON.stringify(book) });
                    }
                    alert("åŒ¯å…¥å®Œæˆï¼");
                    loadFromCloud();
                }
            } catch (err) { alert("åŒ¯å…¥å¤±æ•—ï¼Œæ ¼å¼ä¸ç¬¦"); }
            showLoading(false);
        };
        reader.readAsText(file);
    }

    function renderTable() {
        const tbody = document.getElementById('bookTableBody');
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        tbody.innerHTML = '';
        
        let displayBooks = allBooks;

        if (currentFilter.key) {
            displayBooks = displayBooks.filter(b => {
                if (currentFilter.key === 'æ¨™ç±¤') return b.tags.includes(currentFilter.value);
                const map = {'ä½œè€…':'author', 'èªè¨€':'language', 'é¡å‹':'bookCategory', 'é—œè¯ID':'relationId', 'è³¼è²·ç‹€æ…‹':'buyStatus', 'å¹³å°':'ePlatform'};
                return b[map[currentFilter.key]] === currentFilter.value;
            });
        }

        if (searchTerm) {
            displayBooks = displayBooks.filter(b => 
                b.title.toLowerCase().includes(searchTerm) || 
                b.author.toLowerCase().includes(searchTerm) || 
                b.ePlatform.toLowerCase().includes(searchTerm) ||
                b.notes.toLowerCase().includes(searchTerm) ||
                b.tags.some(t => t.toLowerCase().includes(searchTerm))
            );
        }

        displayBooks.forEach(book => {
            const row = `<tr>
                <td data-label="è³¼è²·"><span class="clickable" onclick="setFilter('è³¼è²·ç‹€æ…‹','${book.buyStatus}')">${book.buyStatus}</span></td>
                <td data-label="æ›¸å/ä½œè€…"><strong>${book.title}</strong><br><small class="clickable" onclick="setFilter('ä½œè€…','${book.author}')">${book.author}</small></td>
                <td data-label="è¦æ ¼/èªè¨€">${book.format} (v${book.volume})<br><small class="clickable" onclick="setFilter('èªè¨€','${book.language}')">${book.language}</span></td>
                <td data-label="å¹³å°/å‚™è¨»"><span class="clickable" onclick="setFilter('å¹³å°','${book.ePlatform}')">${book.ePlatform}</span><div class="note-text" title="${book.notes}">${book.notes}</div></td>
                <td data-label="é¡å‹/æ¨™ç±¤"><small class="clickable" onclick="setFilter('é¡å‹','${book.bookCategory}')">${book.bookCategory}</small><br>${book.tags.map(t => `<span class="tag-pill" onclick="setFilter('æ¨™ç±¤','${t}')">${t}</span>`).join('')}</td>
                <td data-label="é—œè¯ID"><span class="clickable" onclick="setFilter('é—œè¯ID','${book.relationId}')">${book.relationId}</span></td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }

    function setFilter(key, value) {
        if (!value || value === '-' || value === 'æœªçŸ¥') return;
        currentFilter = { key, value };
        document.getElementById('filterInfo').style.display = 'flex';
        document.getElementById('filterText').innerText = `ç¯©é¸ ${key}: ${value}`;
        renderTable();
    }

    function clearFilter() {
        currentFilter = { key: null, value: null };
        document.getElementById('filterInfo').style.display = 'none';
        renderTable();
    }

    function updateDatalists() {
        const authors = [...new Set(allBooks.map(b => b.author))];
        const platforms = [...new Set(allBooks.map(b => b.ePlatform))].filter(p => p !== '-');
        const langs = [...new Set(allBooks.map(b => b.language))];
        const cats = [...new Set(allBooks.map(b => b.bookCategory))];
        
        document.getElementById('authorList').innerHTML = authors.map(a => `<option value="${a}">`).join('');
        document.getElementById('platList').innerHTML = platforms.map(p => `<option value="${p}">`).join('');
        document.getElementById('langList').innerHTML = langs.map(l => `<option value="${l}">`).join('');
        document.getElementById('catList').innerHTML = cats.map(c => `<option value="${c}">`).join('');
    }

    function showLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }
    loadFromCloud();
</script>
</body>
</html>
