<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“š ã„ã„‡çš„è³¼æ›¸ç´€éŒ„ V7.5</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f0f2f5; padding: 15px; margin: 0; }
        .container { max-width: 1400px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; font-size: 24px; margin-bottom: 10px; }
        .backup-zone { text-align: right; margin-bottom: 10px; }
        .btn-secondary { background:#6c757d; color:white; padding:6px 12px; border:none; border-radius:4px; cursor:pointer; font-size: 12px; margin-left: 5px; }
        .search-section { margin-bottom: 20px; }
        #searchInput { width: 100%; border: 2px solid #007bff; padding: 12px; border-radius: 25px; box-sizing: border-box; font-size: 16px; }
        .form-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: 8px; background: #fafafa; }
        .form-full { grid-column: 1 / -1; }
        label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 5px; color: #555; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
        .checkbox-group { display: flex; align-items: center; font-size: 13px; color: #333; margin-top: 5px; }
        .checkbox-group input { width: auto; margin-right: 5px; }
        .btn-add { grid-column: 1 / -1; padding: 15px; background-color: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold; margin-top: 5px; transition: 0.3s; }
        .btn-add.editing { background-color: #ffc107; color: #000; }
        .version-btn { grid-column: 1 / -1; padding: 12px; background: #6f42c1; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; margin-bottom: 5px; }
        .version-btn:hover { background: #5a32a3; }
        .filter-info { background: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 10px; display: none; justify-content: space-between; align-items: center; border: 1px solid #ffeeba; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); display: none; justify-content: center; align-items: center; z-index: 999; font-weight: bold; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; table-layout: fixed; }
        th, td { border-bottom: 1px solid #eee; padding: 12px 8px; text-align: left; vertical-align: top; word-wrap: break-word; }
        th { background-color: #f8f9fa; color: #666; font-weight: bold; border-top: 2px solid #007bff; }
        
        .tag-pill { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; background: #e9ecef; margin-right: 4px; margin-bottom: 4px; cursor: pointer; border: 1px solid #ccc; }
        .format-pill { background: #d1ecf1; color: #007bff; border: 1px solid #bee5eb; }
        .alert-pill { background: #f8d7da !important; color: #dc3545 !important; border: 1px solid #f5c6cb !important; }
        .type-pill { background: #e2e3e5; color: #383d41; border: 1px solid #d6d8db; }
        .edit-link { color: #28a745 !important; font-weight: bold; cursor: pointer; text-decoration: underline; }
        .progress-text { font-weight: bold; color: #333; }
        .btn-delete { background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        
        .locked-field { opacity: 0.5; pointer-events: none; background-color: #f0f0f0; }

        @media (max-width: 800px) {
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { border: 1px solid #ccc; margin-bottom: 15px; border-radius: 8px; padding: 10px; background: #fff; }
            td { border: none; position: relative; padding-left: 40%; margin-bottom: 8px; }
            td:before { position: absolute; left: 10px; width: 35%; font-weight: bold; content: attr(data-label); color: #007bff; }
        }
    </style>
</head>
<body>
<div id="loading" class="loading-overlay">â˜ï¸ åŒæ­¥ä¸­...</div>
<div class="container">
    <h1>ğŸ“š ã„ã„‡çš„è³¼æ›¸ç´€éŒ„</h1>
    <div class="backup-zone">
        <button class="btn-secondary" onclick="exportBackup()">ğŸ’¾ åŒ¯å‡º JSON å‚™ä»½</button>
        <button class="btn-secondary" onclick="document.getElementById('importFile').click()">ğŸ“¤ åŒ¯å…¥å‚™ä»½æª”</button>
        <input type="file" id="importFile" style="display:none" onchange="importBackup(event)">
    </div>
    <div class="search-section"><input type="text" id="searchInput" placeholder="ğŸ” æœå°‹..." oninput="renderTable()"></div>
    
    <div class="form-group" id="inputForm">
        <button type="button" class="version-btn" id="addVersionBtn" onclick="toggleMultiVersion()">â• ç‚ºæœ¬æ›¸æ–°å¢å…¶ä»–ç‰ˆæœ¬è³‡æ–™ (é–å®šæ›¸å/ä½œè€…/ä½œå“å±¬æ€§)</button>
        
        <div id="divTitle"><label>æ›¸å (å¿…å¡«)</label><input type="text" id="title" placeholder="ä¾‹ï¼šå“ˆåˆ©æ³¢ç‰¹"></div>
        <div id="divAuthor"><label>ä½œè€…</label><input list="authorList" id="author" placeholder="ä¾‹ï¼šJ.K. ç¾…ç³"><datalist id="authorList"></datalist></div>
        <div id="divCat"><label>æ›¸ç±é¡å‹</label><input list="catList" id="bookCategory" placeholder="ä¾‹ï¼šæ¼«ç•«"><datalist id="catList"></datalist></div>
        <div id="divSubCat"><label>æ›¸ç±é¡åˆ¥ (é€—è™Ÿéš”é–‹)</label><input list="subCatList" id="subCategory" placeholder="ä¾‹ï¼šæ—¥æœ¬, BL"><datalist id="subCatList"></datalist></div>

        <div><label>è³¼è²·ç‹€æ…‹</label><select id="buyStatus"><option>å·²è²·å®Œ</option><option>æœªè²·å®Œ</option><option>æœªå‡ºå®Œæœªè²·å®Œ</option><option>æœªå‡ºå®Œå·²è²·åˆ°é€²åº¦</option><option>å·²è³¼è²·</option><option>é‡è¤‡è³¼è²·</option><option>å·²éš±è—</option></select></div>
        <div><label>å…§æ–‡èªè¨€</label><input list="langList" id="language" placeholder="ä¾‹ï¼šç¹é«”ä¸­æ–‡"><datalist id="langList"></datalist></div>
        <div><label>å½¢å¼ (ä¾‹ï¼šå¯¦é«”æ›¸, é›»å­æ›¸)</label><input list="formatList" id="format" placeholder="å¯å¡«å¤šå€‹"><datalist id="formatList"><option value="å¯¦é«”æ›¸"><option value="é›»å­æ›¸"></datalist></div>
        <div><label>æ›¸ç±ä½ç½®</label><input list="platList" id="ePlatform" placeholder="ä¾‹ï¼šè€å®¶, BW"><datalist id="platList"></datalist></div>

        <div id="divVol">
            <label>ç›®å‰è³¼è²·é›†æ•¸</label>
            <input type="number" id="volume" value="1">
            <div class="checkbox-group">
                <input type="checkbox" id="isSingleVolume" onchange="handleSingleVolume(this)">
                <label for="isSingleVolume" style="display:inline; font-size:12px;">æ­¤æ›¸å…¨ä¸€é›†å®Œçµ</label>
            </div>
        </div>
        <div id="divWork"><label>ä½œå“ç‹€æ…‹</label><input list="workList" id="workStatus" placeholder="ä¾‹ï¼šæ­£æ–‡å®Œçµ"><datalist id="workList"></datalist></div>
        <div id="divRead"><label>é–±è®€ç‹€æ…‹</label><input list="readList" id="readProgress" placeholder="ä¾‹ï¼šæœªè®€"><datalist id="readList"></datalist></div>
        <div id="divTags"><label>æ¨™ç±¤ (é€—è™Ÿéš”é–‹)</label><input list="tagMemoryList" id="tags" placeholder="ä¾‹ï¼šæ¨ç†"><datalist id="tagMemoryList"></datalist></div>
        <div id="divRel" class="form-full"><label>é—œè¯ ID</label><input list="relList" id="relationId" placeholder="ä¾‹ï¼šHP"><datalist id="relList"></datalist></div>
        <div class="form-full"><label>å‚™è¨» (ç‰ˆæœ¬å·®ç•°å¯å¯«åœ¨æ­¤)</label><textarea id="notes" rows="2" placeholder="è©³ç´°å‚™è¨»..."></textarea></div>
        
        <button class="btn-add" id="saveBtn" onclick="checkAndSave()">å„²å­˜æ›¸å–®è‡³é›²ç«¯</button>
        <button class="btn-secondary form-full" id="cancelBtn" style="display:none; padding:10px;" onclick="resetForm()">å–æ¶ˆ/çµæŸé–å®šç‹€æ…‹</button>
    </div>

    <div id="filterInfo" class="filter-info"><span id="filterText"></span><button onclick="clearFilter()">æ¸…é™¤ç¯©é¸</button></div>
    
    <table id="bookTable">
        <thead>
            <tr>
                <th style="width: 120px;">æ›¸ç±ä½ç½®</th>
                <th style="width: 100px;">å½¢å¼</th>
                <th style="width: 150px;">è³¼è²·ç‹€æ³</th>
                <th style="width: 100px;">é–±è®€ç‹€æ…‹</th>
                <th style="width: 150px;">æ›¸å/ä½œè€…</th>
                <th style="width: 150px;">æ¨™ç±¤/é¡åˆ¥</th>
                <th>å‚™è¨»</th>
                <th style="width: 60px;">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="bookTableBody"></tbody>
    </table>
    <div id="statsPanel" class="stats-panel"></div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbw3MN10RIbddtC_M9Z6zLaP608ZpFDsjKE7Od4s4uSQA5HIEBHH22gTYFkN8pOaTsZO/exec"; 
    let allBooks = []; 
    let currentFilter = { key: null, value: null };
    let isEditing = false;
    let isAddingVersion = false;

    function getPillClass(text) { return text.includes('æœª') ? 'tag-pill alert-pill' : 'tag-pill format-pill'; }
    function getMultiPillHtml(fieldValue, filterKey, customClass = '') {
        if (!fieldValue || fieldValue === '-' || fieldValue === 'ç„¡') return '';
        const parts = fieldValue.split(/[ï¼Œ,]/).map(s => s.trim()).filter(Boolean);
        return parts.map(p => `<span class="${customClass || getPillClass(p)}" onclick="setFilter('${filterKey}','${p}')">${p}</span>`).join('');
    }

    function toggleMultiVersion() {
        const titleVal = document.getElementById('title').value;
        if (!titleVal) return alert("è«‹å…ˆå¡«å¯«æ›¸åï¼Œå†é€²å…¥æ–°å¢ç‰ˆæœ¬æ¨¡å¼ã€‚");
        isAddingVersion = true; isEditing = false;
        ["divTitle", "divAuthor", "divCat", "divSubCat", "divWork", "divRead", "divTags", "divRel"].forEach(id => {
            document.getElementById(id).classList.add('locked-field');
        });
        document.getElementById('language').value = ""; document.getElementById('format').value = "";
        document.getElementById('ePlatform').value = ""; document.getElementById('notes').value = "ç‰ˆæœ¬å·®ç•°ï¼š";
        document.getElementById('saveBtn').innerText = "å„²å­˜æ­¤æ–°ç‰ˆæœ¬è³‡æ–™";
        document.getElementById('saveBtn').style.backgroundColor = "#6f42c1";
        document.getElementById('addVersionBtn').style.display = "none";
        document.getElementById('cancelBtn').style.display = 'block';
    }

    async function deleteBook(title, language, format) {
        if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Š${title}ã€‹çš„ ${language} ${format} ç‰ˆæœ¬å—ï¼Ÿ`)) return;
        showLoading(true);
        try { await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', title: title, language: language, format: format }) }); loadFromCloud(); } catch (e) { alert("å¤±æ•—ï¼š" + e); }
        showLoading(false);
    }

    function editBook(title, language, format) {
        const book = allBooks.find(b => b.title === title && b.language === language && b.format.join(',') === format);
        if (!book) return;
        isEditing = true; isAddingVersion = false;
        window.scrollTo({ top: 0, behavior: 'smooth' });
        document.getElementById('buyStatus').value = book.buyStatus;
        document.getElementById('title').value = book.title;
        document.getElementById('author').value = book.author;
        document.getElementById('language').value = book.language;
        document.getElementById('bookCategory').value = book.bookCategory;
        document.getElementById('subCategory').value = book.subCategory;
        document.getElementById('format').value = book.format.join(', ');
        document.getElementById('ePlatform').value = book.ePlatform;
        document.getElementById('workStatus').value = book.workStatus;
        document.getElementById('readProgress').value = book.readProgress;
        document.getElementById('tags').value = book.tags.join(', ');
        document.getElementById('relationId').value = book.relationId;
        document.getElementById('notes').value = book.notes;
        const isSingle = book.volume === "1(å…¨)";
        document.getElementById('isSingleVolume').checked = isSingle;
        document.getElementById('volume').value = isSingle ? 1 : book.volume;
        document.getElementById('volume').disabled = isSingle;
        document.getElementById('saveBtn').innerText = "æ›´æ–°æ­¤ç‰ˆæœ¬è³‡è¨Š";
        document.getElementById('saveBtn').style.backgroundColor = "";
        document.getElementById('saveBtn').classList.add('editing');
        document.getElementById('cancelBtn').style.display = 'block';
        document.getElementById('addVersionBtn').style.display = "block";
    }

    function resetForm() {
        isEditing = false; isAddingVersion = false;
        document.getElementById('inputForm').querySelectorAll('input, select, textarea').forEach(el => {
            if (el.type !== 'checkbox') el.value = ''; if (el.id === 'volume') el.value = 1;
        });
        document.querySelectorAll('.locked-field').forEach(el => el.classList.remove('locked-field'));
        document.getElementById('isSingleVolume').checked = false;
        document.getElementById('volume').disabled = false;
        document.getElementById('saveBtn').innerText = "å„²å­˜æ›¸å–®è‡³é›²ç«¯";
        document.getElementById('saveBtn').style.backgroundColor = "";
        document.getElementById('saveBtn').classList.remove('editing');
        document.getElementById('addVersionBtn').style.display = "block";
        document.getElementById('cancelBtn').style.display = 'none';
    }

    function handleSingleVolume(cb) { const volInput = document.getElementById('volume'); volInput.disabled = cb.checked; if (cb.checked) volInput.value = 1; }
    function checkAndSave() {
        const title = document.getElementById('title').value;
        const format = document.getElementById('format').value;
        if (!title || !format) return alert("æ›¸åèˆ‡å½¢å¼å¿…å¡«ï¼");
        saveToCloud();
    }

    async function saveToCloud() {
        showLoading(true);
        const bookData = {
            action: 'save', buyStatus: document.getElementById('buyStatus').value,
            title: document.getElementById('title').value, author: document.getElementById('author').value || 'æœªçŸ¥',
            language: document.getElementById('language').value || 'æœªåˆ†é¡', bookCategory: document.getElementById('bookCategory').value || 'æœªåˆ†é¡',
            subCategory: document.getElementById('subCategory').value || '',
            format: document.getElementById('format').value, ePlatform: document.getElementById('ePlatform').value || '-',
            volume: document.getElementById('isSingleVolume').checked ? "1(å…¨)" : document.getElementById('volume').value,
            workStatus: document.getElementById('workStatus').value, readProgress: document.getElementById('readProgress').value || 'ç„¡',
            tags: document.getElementById('tags').value, relationId: document.getElementById('relationId').value || '-',
            notes: document.getElementById('notes').value || ''
        };
        try { 
            await fetch(API_URL, { method: 'POST', body: JSON.stringify(bookData) }); 
            if (isAddingVersion) {
                document.getElementById('language').value = ""; document.getElementById('format').value = "";
                document.getElementById('ePlatform').value = ""; document.getElementById('notes').value = "ç‰ˆæœ¬å·®ç•°ï¼š";
                alert("âœ… æ­¤ç‰ˆæœ¬å·²å„²å­˜ï¼Œæ‚¨å¯ä»¥ç¹¼çºŒå¡«å¯«ä¸‹ä¸€å€‹ç‰ˆæœ¬ï¼");
            } else { alert("âœ… å„²å­˜æˆåŠŸï¼"); resetForm(); }
            loadFromCloud(); 
        } catch (e) { alert("å¤±æ•—ï¼š" + e); }
        showLoading(false);
    }

    async function loadFromCloud() {
        showLoading(true);
        try {
            const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'read' }) });
            const data = await response.json();
            allBooks = data.map(row => ({
                buyStatus: row[0], title: row[1], author: row[2], language: row[3], bookCategory: row[4],
                subCategory: row[5], format: typeof row[6] === 'string' ? row[6].split(',').map(s=>s.trim()).filter(Boolean) : [row[6]],
                ePlatform: row[7], volume: row[8], workStatus: row[9], readProgress: row[10],
                tags: typeof row[11] === 'string' ? row[11].split(',').map(s=>s.trim()).filter(Boolean) : [],
                relationId: row[12], notes: row[13]
            }));
            allBooks.sort((a, b) => a.title.localeCompare(b.title, 'zh-Hant'));
            updateDatalists(); renderTable(); updateStats();
        } catch (e) { console.error(e); }
        showLoading(false);
    }

    function renderTable() {
        const tbody = document.getElementById('bookTableBody'); const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        tbody.innerHTML = ''; let displayBooks = allBooks;
        if (currentFilter.key) {
            displayBooks = allBooks.filter(b => {
                if (currentFilter.key === 'æ¨™ç±¤') return b.tags.includes(currentFilter.value) || b.bookCategory === currentFilter.value || b.subCategory.split(/[ï¼Œ,]/).includes(currentFilter.value);
                if (currentFilter.key === 'å½¢å¼') return b.format.includes(currentFilter.value);
                if (currentFilter.key === 'ä½ç½®') return b.ePlatform.split(/[ï¼Œ,]/).map(s => s.trim()).includes(currentFilter.value);
                const map = {'ä½œè€…':'author', 'èªè¨€':'language', 'é—œè¯ID':'relationId', 'è³¼è²·':'buyStatus', 'ä½œå“':'workStatus', 'é–±è®€':'readProgress'};
                return b[map[currentFilter.key]] === currentFilter.value;
            });
        }
        if (searchTerm) { displayBooks = displayBooks.filter(b => b.title.toLowerCase().includes(searchTerm) || b.tags.some(t => t.toLowerCase().includes(searchTerm)) || b.notes.toLowerCase().includes(searchTerm)); }

        displayBooks.forEach(book => {
            const volDisplay = book.volume.toString().includes('(å…¨)') ? book.volume : book.volume + 'é›†';
            const buyStatusClass = book.buyStatus.includes('æœª') ? 'alert-text' : '';

            tbody.innerHTML += `<tr>
                <td data-label="æ›¸ç±ä½ç½®">${getMultiPillHtml(book.ePlatform, 'ä½ç½®')}</td>
                <td data-label="å½¢å¼">
                    <span class="${getPillClass(book.language)}" onclick="setFilter('èªè¨€','${book.language}')">${book.language}</span><br>
                    ${book.format.map(f => `<span class="${getPillClass(f)}" onclick="setFilter('å½¢å¼','${f}')">${f}</span>`).join('')}
                </td>
                <td data-label="è³¼è²·ç‹€æ³">
                    <span class="progress-text">${volDisplay} ${book.workStatus}</span>
                    <div class="progress-sub clickable ${buyStatusClass}" onclick="setFilter('è³¼è²·','${book.buyStatus}')">(${book.buyStatus})</div>
                </td>
                <td data-label="é–±è®€ç‹€æ…‹"><span class="${getPillClass(book.readProgress)}" onclick="setFilter('é–±è®€','${book.readProgress}')">${book.readProgress}</span></td>
                <td data-label="æ›¸å/ä½œè€…">
                    <strong class="edit-link" onclick="editBook('${book.title.replace(/'/g, "\\'")}', '${book.language}', '${book.format.join(',')}')">${book.title}</strong><br>
                    <small onclick="setFilter('ä½œè€…','${book.author}')" style="cursor:pointer; color:#007bff; text-decoration:underline;">${book.author}</small>
                </td>
                <td data-label="æ¨™ç±¤">
                    <span class="tag-pill type-pill" onclick="setFilter('æ¨™ç±¤','${book.bookCategory}')">${book.bookCategory}</span>
                    ${getMultiPillHtml(book.subCategory, 'æ¨™ç±¤', 'tag-pill type-pill')}
                    ${book.tags.map(t => `<span class="tag-pill" onclick="setFilter('æ¨™ç±¤','${t}')">${t}</span>`).join('')}
                    <div style="margin-top:4px"><span class="tag-pill" style="background:#fff" onclick="setFilter('é—œè¯ID','${book.relationId}')">#${book.relationId}</span></div>
                </td>
                <td data-label="å‚™è¨»" class="note-cell">${book.notes}</td>
                <td data-label="æ“ä½œ"><button class="btn-delete" onclick="deleteBook('${book.title.replace(/'/g, "\\'")}', '${book.language}', '${book.format.join(',')}')">åˆªé™¤</button></td>
            </tr>`;
        });
    }

    function setFilter(key, value) { currentFilter = { key, value }; document.getElementById('filterInfo').style.display = 'flex'; document.getElementById('filterText').innerText = `ç¯©é¸ ${key}: ${value}`; renderTable(); }
    function clearFilter() { currentFilter = { key: null, value: null }; document.getElementById('filterInfo').style.display = 'none'; renderTable(); }
    function exportBackup() { const blob = new Blob([JSON.stringify(allBooks, null, 2)], { type: "application/json" }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `æ›¸åº«å‚™ä»½_${new Date().toISOString().slice(0,10)}.json`; link.click(); }
    function importBackup(e) { const reader = new FileReader(); reader.onload = async function(ev) { const data = JSON.parse(ev.target.result); if (confirm(`åŒ¯å…¥ ${data.length} ç­†è³‡æ–™ï¼Ÿ`)) { showLoading(true); for (const b of data) { b.action='save'; b.tags=Array.isArray(b.tags)?b.tags.join(','):b.tags; b.format=Array.isArray(b.format)?b.format.join(','):b.format; await fetch(API_URL,{method:'POST',body:JSON.stringify(b)}); } loadFromCloud(); } }; reader.readAsText(e.target.files[0]); }
    function updateDatalists() { 
        const getUniques = (key) => [...new Set(allBooks.map(b => b[key]))].filter(v => v && v !== '-' && v !== 'æœªçŸ¥' && v !== 'ç„¡');
        const fillList = (id, list) => { document.getElementById(id).innerHTML = list.map(v => `<option value="${v}">`).join(''); };
        fillList('authorList', getUniques('author')); fillList('langList', getUniques('language')); fillList('catList', getUniques('bookCategory')); fillList('platList', getUniques('ePlatform'));
        fillList('formatList', [...new Set(allBooks.flatMap(b => b.format))]); fillList('readList', getUniques('readProgress')); fillList('tagMemoryList', [...new Set(allBooks.flatMap(b => b.tags))]); fillList('relList', getUniques('relationId'));
        fillList('workList', getUniques('workStatus'));
        fillList('subCatList', [...new Set(allBooks.flatMap(b => b.subCategory.split(/[ï¼Œ,]/).map(s => s.trim()).filter(Boolean)))]);
    }
    function updateStats() {
        const statsPanel = document.getElementById('statsPanel');
        if (allBooks.length === 0) { statsPanel.innerHTML = ""; return; }
        const formatCounts = {}; const categoryCounts = {};
        allBooks.forEach(book => {
            book.format.forEach(f => { formatCounts[f] = (formatCounts[f] || 0) + 1; });
            const cat = book.bookCategory || "æœªåˆ†é¡"; categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
        });
        let html = `<div class="stats-item">ç¸½åœ–æ›¸é‡ï¼š<strong>${allBooks.length}</strong> æœ¬</div><div class="stats-item">å½¢å¼çµ±è¨ˆï¼š`;
        for (let f in formatCounts) { html += `${f}(<strong>${formatCounts[f]}</strong>) `; }
        html += `</div><div class="stats-item">æ›¸ç±é¡å‹çµ±è¨ˆï¼š`;
        for (let c in categoryCounts) { html += `${c}(<strong>${categoryCounts[c]}</strong>) `; }
        statsPanel.innerHTML = html + `</div>`;
    }
    function showLoading(s) { document.getElementById('loading').style.display = s ? 'flex' : 'none'; }
    loadFromCloud();
</script>
</body>
</html>
