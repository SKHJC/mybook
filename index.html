<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“š ã„ã„‡çš„è³¼æ›¸ç´€éŒ„ V17.8</title>
    
    <style>
        /* --- æ ¸å¿ƒæ’ç‰ˆï¼šæœ€å¤§åŒ–å¯¬åº¦èˆ‡æœ€å°ç•™ç™½ --- */
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f8f9fa; padding: 10px; margin: 0; color: #333; }
        
        .container { 
            width: 98%; 
            max-width: none; 
            min-width: fit-content; 
            margin: 10px auto; 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            box-sizing: border-box;
        }

        .table-responsive {
            width: 100%;
            overflow-x: auto;
            margin-top: 10px;
            border-radius: 8px;
        }

        h1 { text-align: center; color: #333; font-size: 24px; margin-bottom: 20px; letter-spacing: 1px; }
        
        /* è¡¨å–® UI */
        .form-group { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; padding: 25px; border: 1px solid #eee; border-radius: 12px; background: #fafafa; }
        .form-full { grid-column: 1 / -1; }
        label { display: block; font-size: 13px; font-weight: bold; margin-bottom: 8px; color: #555; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; background: white; }
        
        .locked-field { background-color: #e9ecef !important; cursor: not-allowed; border: 1px solid #ccc !important; color: #6c757d; }
        
        /* å‹¾é¸é¸é …æ¨£å¼ */
        .checkbox-container { display: flex; align-items: center; gap: 5px; margin-top: 8px; cursor: pointer; user-select: none; color: #666; font-size: 12px; }
        .checkbox-container input { width: 13px; height: 13px; cursor: pointer; margin: 0; }
        .checkbox-row { display: flex; flex-wrap: wrap; gap: 10px; grid-column: 1 / -1; margin-top: -5px; margin-bottom: 10px; }
        .checkbox-row-container { display: flex; flex-direction: column; gap: 2px; }

        .btn-group-vertical { grid-column: 1 / -1; display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        .btn-version { background-color: #6f42c1; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .btn-save { background-color: #28a745; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold; }
        .btn-update { background-color: #ffc107; color: #333; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold; display: none; }
        .btn-cancel { background-color: #6c757d; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 16px; display: none; }
        .btn-sync-unlock { background-color: #17a2b8; color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold; margin-bottom: 10px; display: none; }

        .filter-zone { text-align: center; margin-bottom: 20px; }
        .rating-filter-container { margin: 15px 0; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .rating-filter-select { width: auto; min-width: 200px; padding: 8px 15px; border-radius: 20px; border: 1px solid #007bff; font-weight: bold; color: #007bff; cursor: pointer; background: white; }

        .bottom-zone { margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; text-align: center; }
        .btn-home { background: #007bff; color: white; padding: 12px 30px; border-radius: 30px; font-size: 16px; font-weight: bold; border: none; cursor: pointer; box-shadow: 0 4px 10px rgba(0,123,255,0.2); transition: 0.2s; margin-bottom: 20px; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; }
        .btn-home:hover { background: #0056b3; box-shadow: 0 6px 15px rgba(0,123,255,0.3); transform: translateY(-2px); }

        .category-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 10px; }
        .cat-btn { background: #fff; color: #495057; padding: 8px 20px; border-radius: 20px; font-size: 14px; font-weight: bold; cursor: pointer; border: 1px solid #6c757d; transition: 0.2s; }
        .cat-btn.active { background: #007bff; color: #fff; border-color: #007bff; box-shadow: 0 4px 10px rgba(0,123,255,0.3); }

        .sub-filter-container { display: none; flex-direction: column; gap: 15px; margin: 10px 0 20px; padding: 15px; background: #f8f9fa; border-radius: 15px; border: 1px solid #eee; }
        .sub-filter-row { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .sub-filter-label { font-size: 13px; color: #888; width: 100%; text-align: center; margin-bottom: 5px; }

        .sub-cat-btn { background: #e9ecef; color: #495057; padding: 6px 16px; border-radius: 20px; font-size: 14px; cursor: pointer; border: 1px solid #dee2e6; transition: 0.2s; }
        .sub-cat-btn.active { background: #17a2b8; color: #fff; border-color: #17a2b8; }
        
        .search-area { display: flex; gap: 10px; margin-bottom: 20px; position: relative; }
        #searchInput { flex: 1; padding: 12px 20px; border-radius: 25px; border: 2px solid #007bff; font-size: 16px; }
        .search-trigger-btn { background: #007bff; color: white; border: none; width: 50px; height: 46px; border-radius: 23px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: 0.2s; }

        /* æ¨™ç±¤é…è‰² */
        .tag-pill { display: inline-block; padding: 4px 12px; border-radius: 15px; font-size: 13px; margin-right: 5px; margin-bottom: 5px; cursor: pointer; border: none; transition: 0.1s; vertical-align: middle; }
        .pill-publisher { background: #019858 !important; color: white !important; }
        .pill-serial { background: #00CACA !important; color: white !important; }
        .pill-drama { background: #81C0C0 !important; color: white !important; }
        .pill-main { background: #0000E3 !important; color: white !important; }
        .pill-special-cat { background: #005AB5 !important; color: white !important; }
        .pill-category { background: #4A4AFF !important; color: white !important; }
        .pill-sub { background: #97CBFF !important; color: white !important; }
        .pill-relation { background: #7D7DFF !important; color: white !important; font-weight: bold; }
        .status-pill { background: #0077FF !important; color: white !important; font-weight: bold; }
        .alert-pill { background: #dc3545 !important; color: white !important; font-weight: bold; }
        .pill-location { background: #177245 !important; color: white !important; }
        
        .pill-multi-version { 
            background: #8AECFF !important; 
            color: white !important; 
            font-weight: normal !important; 
            border-radius: 4px !important; 
            padding: 2px 8px !important;
            font-size: 11px !important;
            margin-bottom: 5px;
            display: inline-block;
        }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; table-layout: fixed; min-width: 1000px; }
        th { background-color: #f8f9fa; color: #666; font-weight: bold; padding: 15px 10px; border-bottom: 2px solid #007bff; text-align: left; }
        td { padding: 15px 10px; border-bottom: 1px solid #eee; vertical-align: middle; }

        .notes-column { min-width: 220px; word-break: break-all; white-space: normal; line-height: 1.6; color: #555; }
        .notes-box { padding: 5px 0; font-size: 13px; color: #333; font-weight: 500; }

        /* å¿ƒå¾—å±•ç¤ºæ¨£å¼ */
        .review-toggle-btn { background: #fff; color: #6f42c1; border: 1px solid #d1c4e9; padding: 2px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; margin-top: 5px; display: inline-block; transition: 0.2s; }
        .review-toggle-btn:hover { background: #f3f0ff; border-color: #6f42c1; }
        .review-content { display: none; background: #fff9db; padding: 10px; border-radius: 8px; border-left: 4px solid #fcc419; margin-top: 8px; font-size: 13px; color: #444; white-space: pre-wrap; word-break: break-all; }

        .action-btns { margin-top: 8px; display: flex; gap: 5px; }
        .btn-edit-small { background:#28a745; color:white; border:none; padding:4px 10px; border-radius:4px; cursor:pointer; font-size: 12px; }
        .btn-del-small { background:#dc3545; color:white; border:none; padding:4px 10px; border-radius:4px; cursor:pointer; font-size: 12px; }

        .stats-panel { display: flex; flex-wrap: wrap; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 12px; border: 1px solid #eee; justify-content: center; }
        .stats-item { background: white; padding: 8px 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 14px; color: #444; border: 1px solid #fff; }

        @media (max-width: 800px) {
            .form-group { grid-template-columns: 1fr 1fr; }
            .container { width: 95%; min-width: auto; }
            .table-responsive { overflow-x: visible; }
            table, thead, tbody, th, td, tr { display: block; min-width: auto; }
            thead { display: none; }
            .group-row-container { border: 1px solid #ddd; margin-bottom: 25px; border-radius: 12px; background: #fff; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
            td { border: none !important; position: relative; padding: 12px 15px 12px 110px !important; border-bottom: 1px solid #f8f9fa !important; width: 100% !important; box-sizing: border-box; }
            td:before { content: attr(data-label); position: absolute; left: 15px; width: 80px; font-weight: bold; color: #007bff; font-size: 13px; }
            .mobile-title-row { display: flex; justify-content: space-between; align-items: flex-start; }
            .action-btns { margin-top: 0; }
            .notes-column { min-width: auto !important; }
        }

        .pagination { display: flex; justify-content: center; align-items: center; gap: 8px; margin: 30px 0; }
        .page-btn { padding: 8px 16px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 6px; }
        .page-btn.active { background: #007bff; color: white; border-color: #007bff; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: none; justify-content: center; align-items: center; z-index: 9999; }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay">âš™ï¸ æ­£åœ¨è™•ç†ä¸­...</div>

<div class="container">
    <h1>ğŸ“š ã„ã„‡çš„è³¼æ›¸ç´€éŒ„ V17.8</h1>

    <div class="form-group" id="inputForm">
        <div><label>æ›¸å (å¿…å¡«)</label><input type="text" id="title" placeholder="ä¾‹ï¼šå“ˆåˆ©æ³¢ç‰¹"></div>
        <div>
            <label>ä½œè€… *</label>
            <input type="text" id="author" list="authorList" placeholder="ä¾‹ï¼šJ.K. ç¾…ç³">
            <div class="checkbox-row">
                <label class="checkbox-container"><input type="checkbox" name="authorRole" value="åŸä½œè€…"><span>åŸä½œè€…</span></label>
                <label class="checkbox-container"><input type="checkbox" name="authorRole" value="æ”¹ç·¨"><span>æ”¹ç·¨</span></label>
            </div>
        </div>
        <div><label>ä½œè€…åœ‹ç± *</label><input type="text" id="nationality" list="natList" placeholder="ä¾‹ï¼šè‹±åœ‹"></div>
        
        <div>
            <label>æ›¸ç±é¡å‹ (é€—è™Ÿéš”é–‹) â‚</label>
            <input type="text" id="bookCategory" list="catList" placeholder="ä¾‹ï¼šæ¼«ç•«">
            <div class="checkbox-row-container">
                <div class="checkbox-row">
                    <label class="checkbox-container"><input type="checkbox" name="typeCheck" value="çºŒä½œ"><span>çºŒä½œ</span></label>
                    <label class="checkbox-container"><input type="checkbox" name="typeCheck" value="å‰ä½œ"><span>å‰ä½œ</span></label>
                    <label class="checkbox-container"><input type="checkbox" name="typeCheck" value="å¤–å‚³"><span>å¤–å‚³</span></label>
                    <label class="checkbox-container"><input type="checkbox" name="typeCheck" value="ç•ªå¤–"><span>ç•ªå¤–</span></label>
                </div>
                <div class="checkbox-row">
                    <label class="checkbox-container"><input type="checkbox" name="typeCheck" value="æ”¹ç·¨è‡ªå‹•ç•«"><span>æ”¹ç·¨è‡ªå‹•ç•«</span></label>
                    <label class="checkbox-container"><input type="checkbox" name="typeCheck" value="æ”¹ç·¨è‡ªæ¼«ç•«"><span>æ”¹ç·¨è‡ªæ¼«ç•«</span></label>
                </div>
                <div class="checkbox-row">
                    <label class="checkbox-container"><input type="checkbox" name="typeCheck" value="æ”¹ç·¨è‡ªå½±åŠ‡"><span>æ”¹ç·¨è‡ªå½±åŠ‡</span></label>
                    <label class="checkbox-container"><input type="checkbox" name="typeCheck" value="æ”¹ç·¨è‡ªå°èªª"><span>æ”¹ç·¨è‡ªå°èªª</span></label>
                </div>
            </div>
        </div>
        
        <div><label>æ›¸ç±é¡åˆ¥ (é€—è™Ÿéš”é–‹) â‚</label><input type="text" id="subCategory" list="subCatList" placeholder="ä¾‹ï¼šæ—¥æœ¬, BL"></div>
        <div><label>è³¼è²·ç‹€æ…‹ *</label>
            <select id="buyStatus">
                <option value="" disabled selected>è«‹é¸æ“‡...</option>
                <option>å·²è²·å®Œ</option><option>æœªè²·å®Œ</option><option>å·²å‡ºå®Œæœªè²·å®Œ</option><option>æœªå‡ºå®Œæœªè²·å®Œ</option>
                <option>æœªå‡ºå®Œå·²è²·åˆ°é€²åº¦</option><option>å·²è³¼è²·</option><option>é‡è¤‡è³¼è²·</option>
                <option>0å…ƒæ›¸</option><option>è´ˆå“</option><option>è©¦é–±</option>
            </select>
        </div>
        <div><label>å…§æ–‡èªè¨€ *</label><input type="text" id="language" list="langList" placeholder="ä¾‹ï¼šç¹é«”ä¸­æ–‡"></div>
        <div><label>å½¢å¼ (ä¾‹ï¼šå¯¦é«”æ›¸, é›»å­æ›¸) â‚</label><input type="text" id="format" list="formatList" placeholder="å¯å¡«å¤šå€‹"></div>
        
        <div><label>æ›¸ç±ä½ç½® (é€—è™Ÿéš”é–‹) â‚</label><input type="text" id="ePlatform" list="platformList" placeholder="ä¾‹ï¼šBW, å¯¦é«”æ›¸"></div>
        <div id="divVol">
            <label>ç›®å‰è³¼è²·é›†æ•¸/å›æ•¸</label>
            <div style="display: flex; gap: 5px;">
                <input type="number" id="volume" value="1" style="flex: 2;">
                <select id="volumeUnit" style="flex: 1; padding: 5px;">
                    <option>é›†</option><option>å›(è©±)</option><option>ç¯‡</option>
                </select>
            </div>
            <label class="checkbox-container">
                <input type="checkbox" id="isSingleVolume" onchange="handleSingleVolume(this)">
                <span>æ­¤æ›¸å…¨ä¸€é›†å®Œçµ</span>
            </label>
            <label class="checkbox-container">
                <input type="checkbox" id="hasPrologue">
                <span>å«åºç« </span>
            </label>
        </div>
        <div><label>ä½œå“ç‹€æ…‹ *</label><input type="text" id="workStatus" list="workStatusList" placeholder="ä¾‹ï¼šæ­£æ–‡å®Œçµ"></div>
        <div><label>é–±è®€ç‹€æ…‹ *</label><input type="text" id="readProgress" list="readList" placeholder="ä¾‹ï¼šæœªè®€"></div>
        
        <div><label>å‡ºç‰ˆç¤¾ *</label><input type="text" id="publisher" list="publisherList" placeholder="ä¾‹ï¼šçš‡å† "></div>
        <div>
            <label>é€£è¼‰å¹³å° (é€—è™Ÿéš”é–‹) â‚</label>
            <input type="text" id="serialPlatform" list="serialPlatformList" placeholder="ä¾‹ï¼šKakao, æ¼«æ¼«">
            <label class="checkbox-container">
                <input type="checkbox" id="isAudioDrama"> <span>æ­¤ç‚ºå»£æ’­åŠ‡é€£è¼‰å¹³å°</span>
            </label>
        </div>
        
        <div>
            <label>å–œæ­¡ç¨‹åº¦ *</label>
            <select id="rating" onchange="handleRatingChange(this)">
                <option value="" disabled selected>è«‹é¸æ“‡è©•åˆ†...</option>
                <option value="5">â­â­â­â­â­ (5æ˜Ÿ)</option>
                <option value="4">â­â­â­â­ (4æ˜Ÿ)</option>
                <option value="3">â­â­â­ (3æ˜Ÿ)</option>
                <option value="2">â­â­ (2æ˜Ÿ)</option>
                <option value="1">â­ (1æ˜Ÿ)</option>
            </select>
            <div id="discardZone" style="display:none;">
                <label class="checkbox-container" style="color: #dc3545;">
                    <input type="checkbox" id="canDiscard"> <span>å¯è³£æ‰/ä¸Ÿæ‰</span>
                </label>
                <label class="checkbox-container" style="color: #dc3545;">
                    <input type="checkbox" id="willHide"> <span>æƒ³éš±è—</span>
                </label>
            </div>
        </div>

        <div>
            <label>æ˜¯å¦æœƒé‡çœ‹ *</label>
            <select id="reRead">
                <option value="" disabled selected>è«‹é¸æ“‡...</option>
                <option>ä¸é‡çœ‹ç´”æ”¶è—</option>
                <option>é‡çœ‹é›»å­æ›¸</option>
                <option>å¯¦é«”æ›¸é›»å­æ›¸éƒ½æœƒé‡çœ‹</option>
                <option>å¦‚æœå¿˜è¨˜åŠ‡æƒ…æœƒé‡çœ‹</option>
                <option>ä¸€é»éƒ½ä¸æƒ³ç•™</option>
                <option>ä¸ç¹¼çºŒè²·</option>
                <option>å·²éš±è—</option>
            </select>
        </div>

        <div class="form-full"><label>æ¨™ç±¤ (é€—è™Ÿéš”é–‹) â‚</label><input type="text" id="tags" list="tagOptionList" placeholder="ä¾‹ï¼šæ¨ç†"></div>
        <div class="form-full"><label>é—œè¯ ID *</label><input type="text" id="relationId" list="relationIdList" placeholder="ä¾‹ï¼šHP"></div>
        <div class="form-full"><label>å‚™è¨»</label><textarea id="notes" rows="2" placeholder="è©³ç´°å‚™è¨»..."></textarea></div>
        <div class="form-full"><label>å¿ƒå¾—ç°¡è©•</label><textarea id="review" rows="3" placeholder="å¯«ä¸‹ä½ çš„è®€å¾Œå¿ƒå¾—..."></textarea></div>
        
        <div class="btn-group-vertical">
            <button class="btn-sync-unlock" id="syncUnlockBtn" onclick="unlockForSync()">ğŸ”“ è§£é–ä¸¦åŒæ­¥æ‰€æœ‰ç‰ˆæœ¬å…§å®¹</button>
            <button class="btn-version" id="multiVersionBtn" onclick="toggleMultiVersion()">ï¼‹ ç‚ºæœ¬æ›¸æ–°å¢å…¶ä»–ç‰ˆæœ¬è³‡æ–™</button>
            <button class="btn-save" id="saveBtn" onclick="checkAndSave('save')">å„²å­˜æ›¸å–®è‡³é›²ç«¯</button>
            <button class="btn-update" id="updateBtn" onclick="checkAndSave('update')">æ›´æ–°æ­¤ç‰ˆæœ¬è³‡è¨Š</button>
            <button class="btn-cancel" id="cancelBtn" onclick="resetForm()">å–æ¶ˆ/çµæŸé–å®šç‹€æ…‹</button>
        </div>
    </div>

    <datalist id="authorList"></datalist><datalist id="natList"></datalist><datalist id="catList"></datalist><datalist id="subCatList"></datalist><datalist id="langList"></datalist><datalist id="formatList"></datalist><datalist id="platformList"></datalist><datalist id="workStatusList"></datalist><datalist id="readList"></datalist><datalist id="tagOptionList"></datalist><datalist id="publisherList"></datalist><datalist id="serialPlatformList"></datalist><datalist id="relationIdList"></datalist>

    <div class="filter-zone">
        <div id="categoryPanel" class="category-container"></div>
        <div class="rating-filter-container">
            <select id="ratingFilter" class="rating-filter-select" onchange="applyFilters(true)">
                <option value="">â­ ä¾æ˜Ÿæ•¸ç¯©é¸ (å…¨éƒ¨)</option>
                <option value="5">â­â­â­â­â­ (5æ˜Ÿ)</option>
                <option value="4">â­â­â­â­ (4æ˜Ÿ)</option>
                <option value="3">â­â­â­ (3æ˜Ÿ)</option>
                <option value="2">â­â­ (2æ˜Ÿ)</option>
                <option value="1">â­ (1æ˜Ÿ)</option>
            </select>
        </div>
        <div id="subFilterPanel" class="sub-filter-container"></div>
    </div>

    <div class="search-area">
        <input type="text" id="searchInput" placeholder="ğŸ” è¼¸å…¥é—œéµå­—å¾Œé»æ“Šå³å´æŒ‰éˆ•æœå°‹..." onkeypress="if(event.key==='Enter') applyFilters(true)">
        <button class="search-trigger-btn" onclick="applyFilters(true)">ğŸ”</button>
    </div>

    <div id="contentSection" style="display: none;">
        <div class="table-responsive">
            <table id="bookTable">
                <thead>
                    <tr>
                        <th style="width:200px;">æ›¸å/ä½œè€…</th>
                        <th style="width:90px;">é–±è®€ç‹€æ…‹</th>
                        <th style="width:120px;">æ›¸ç±ä½ç½®</th>
                        <th style="width:120px;">å½¢å¼</th>
                        <th style="width:130px;">è³¼è²·ç‹€æ³</th>
                        <th style="width:140px;">è©•åƒ¹/é‡çœ‹</th>
                        <th style="width:200px;">æ¨™ç±¤</th>
                        <th style="width:230px;">å‚™è¨»/å¿ƒå¾—</th>
                    </tr>
                </thead>
                <tbody id="bookTableBody"></tbody>
            </table>
        </div>
        <div id="pagination" class="pagination"></div>
    </div>

    <div class="bottom-zone">
        <button class="btn-home" onclick="clearFilter()">ğŸ  å›é¦–é  (éš±è—è¡¨æ ¼)</button>
        <div id="statsPanel" class="stats-panel"></div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbw3MN10RIbddtC_M9Z6zLaP608ZpFDsjKE7Od4s4uSQA5HIEBHH22gTYFkN8pOaTsZO/exec";
    let allBooks = [], currentFilteredGroups = [], currentPage = 1, itemsPerPage = 10;
    let currentFilter = { key: null, value: null }, secondFilter = null;
    let editingTarget = null;
    let isSyncMode = false;

    function handleRatingChange(el) {
        const discardZone = document.getElementById('discardZone');
        if (parseInt(el.value) <= 3) { discardZone.style.display = 'block'; } 
        else { discardZone.style.display = 'none'; document.getElementById('canDiscard').checked = false; document.getElementById('willHide').checked = false; }
    }

    function getPillClass(text, type) {
        if (!text) return 'tag-pill';
        const alertKeywords = ['æœª', 'æ²’', 'é‡è¤‡', 'ç¼º', 'ä¸', 'å‘'];
        if (alertKeywords.some(k => text.includes(k))) return 'tag-pill alert-pill';
        const specialTypes = ['çºŒä½œ', 'å‰ä½œ', 'å¤–å‚³', 'ç•ªå¤–', 'æ”¹ç·¨è‡ªå‹•ç•«', 'æ”¹ç·¨è‡ªæ¼«ç•«', 'æ”¹ç·¨è‡ªå½±åŠ‡', 'æ”¹ç·¨è‡ªå°èªª'];
        if (specialTypes.includes(text)) return 'tag-pill pill-special-cat';
        if (type === 'status') return 'tag-pill status-pill';
        if (type === 'main') return 'tag-pill pill-main';
        if (type === 'category') return 'tag-pill pill-category';
        if (type === 'serial') return 'tag-pill pill-serial';
        if (type === 'drama') return 'tag-pill pill-drama';
        if (type === 'publisher') return 'tag-pill pill-publisher';
        if (type === 'relation') return 'tag-pill pill-relation';
        if (type === 'location') return 'tag-pill pill-location';
        return 'tag-pill pill-sub';
    }

    async function loadFromCloud() {
        document.getElementById('loading').style.display='flex';
        try {
            const r = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'read' }) });
            const data = await r.json();
            allBooks = data.map(row => {
                let volStr = row[8] ? row[8].toString() : "1";
                let unit = "é›†", hasPrologue = false;
                if(volStr.includes('å›')) unit = "å›(è©±)";
                else if(volStr.includes('ç¯‡')) unit = "ç¯‡";
                if(volStr.includes('å«åºç« ')) hasPrologue = true;

                return {
                    buyStatus: row[0], title: row[1], author: row[2], language: row[3], 
                    bookCategory: row[4], subCategory: row[5],
                    format: row[6] ? row[6].split(',').map(s=>s.trim()) : [],
                    ePlatform: row[7], 
                    volume: volStr, 
                    volumeUnit: unit,
                    hasPrologue: hasPrologue,
                    workStatus: row[9], readProgress: row[10],
                    tags: row[11] ? row[11].split(',').map(s=>s.trim()) : [],
                    relationId: row[12], notes: row[13], nationality: row[14] || '',
                    publisher: row[15] || '', serialPlatform: row[16] || '',
                    rating: row[17] || '', canDiscard: row[18] === 'TRUE' || row[18] === true, reRead: row[19] || '',
                    isAudioDrama: row[20] === 'TRUE' || row[20] === true,
                    willHide: row[21] === 'TRUE' || row[21] === true,
                    authorRole: row[22] || '',
                    review: row[23] || ''
                };
            });
            updateDatalists(); updateCategoryButtons(); updateStats();
        } catch (e) { console.error(e); }
        document.getElementById('loading').style.display='none';
    }

    async function checkAndSave(mode) {
        const titleVal = document.getElementById('title').value;
        if (!titleVal) { alert("æ›¸åç‚ºå¿…å¡«ï¼"); return; }
        document.getElementById('loading').style.display='flex';
        
        let selectedTypes = [];
        document.querySelectorAll('input[name="typeCheck"]:checked').forEach(cb => selectedTypes.push(cb.value));
        let manualType = document.getElementById('bookCategory').value;
        let finalCategory = [manualType, ...selectedTypes].filter(v => v.trim() !== '').join(', ');

        let selectedRoles = [];
        document.querySelectorAll('input[name="authorRole"]:checked').forEach(cb => selectedRoles.push(cb.value));
        let finalRole = selectedRoles.join(',');

        let volVal = document.getElementById('volume').value;
        let unit = document.getElementById('volumeUnit').value;
        let proStr = document.getElementById('hasPrologue').checked ? "å«åºç« " : "";
        let finalVolume = document.getElementById('isSingleVolume').checked ? "1(å…¨)" : (volVal + unit + proStr);

        const bookData = {
            action: 'save', isSyncMode: isSyncMode,
            oldTitle: editingTarget ? editingTarget.title : null,
            oldLang: editingTarget ? editingTarget.language : null,
            oldFormat: editingTarget ? editingTarget.format.join(',') : null,
            buyStatus: document.getElementById('buyStatus').value,
            title: titleVal, author: document.getElementById('author').value,
            nationality: document.getElementById('nationality').value,
            language: document.getElementById('language').value,
            bookCategory: finalCategory,
            subCategory: document.getElementById('subCategory').value,
            format: document.getElementById('format').value,
            ePlatform: document.getElementById('ePlatform').value,
            volume: finalVolume,
            workStatus: document.getElementById('workStatus').value,
            readProgress: document.getElementById('readProgress').value,
            tags: document.getElementById('tags').value, relationId: document.getElementById('relationId').value,
            notes: document.getElementById('notes').value, publisher: document.getElementById('publisher').value,
            serialPlatform: document.getElementById('serialPlatform').value,
            rating: document.getElementById('rating').value, canDiscard: document.getElementById('canDiscard').checked,
            reRead: document.getElementById('reRead').value,
            isAudioDrama: document.getElementById('isAudioDrama').checked,
            willHide: document.getElementById('willHide').checked,
            authorRole: finalRole,
            review: document.getElementById('review').value
        };
        try {
            await fetch(API_URL, { method: 'POST', body: JSON.stringify(bookData) });
            alert(mode === 'update' ? "æ›´æ–°æˆåŠŸï¼" : "å„²å­˜æˆåŠŸï¼");
            const previewName = titleVal;
            resetForm(); 
            await loadFromCloud();
            document.getElementById('searchInput').value = previewName;
            applyFilters(true);
            setTimeout(() => {
                const target = document.getElementById('contentSection');
                if(target) window.scrollTo({ top: target.offsetTop - 50, behavior: 'smooth' });
            }, 500);
        } catch (e) { alert("æ“ä½œå¤±æ•—"); }
        document.getElementById('loading').style.display='none';
    }

    function editBook(t, l, f) {
        const book = allBooks.find(b => b.title === t && b.language === l && b.format.join(',') === f);
        if (!book) return;
        editingTarget = book; isSyncMode = false; window.scrollTo({ top: 0, behavior: 'smooth' });
        
        document.querySelectorAll('input[name="typeCheck"]').forEach(cb => cb.checked = false);
        let cats = book.bookCategory.split(/[ï¼Œ,]/).map(s=>s.trim());
        let specialTypes = ['çºŒä½œ', 'å‰ä½œ', 'å¤–å‚³', 'ç•ªå¤–', 'æ”¹ç·¨è‡ªå‹•ç•«', 'æ”¹ç·¨è‡ªæ¼«ç•«', 'æ”¹ç·¨è‡ªå½±åŠ‡', 'æ”¹ç·¨è‡ªå°èªª'];
        let remainingCats = cats.filter(c => {
            if(specialTypes.includes(c)) {
                let checkbox = document.querySelector(`input[name="typeCheck"][value="${c}"]`);
                if(checkbox) checkbox.checked = true;
                return false;
            }
            return true;
        });

        document.querySelectorAll('input[name="authorRole"]').forEach(cb => {
            cb.checked = (book.authorRole || "").split(',').includes(cb.value);
        });

        document.getElementById('title').value = book.title;
        document.getElementById('author').value = book.author;
        document.getElementById('nationality').value = book.nationality;
        document.getElementById('bookCategory').value = remainingCats.join(', ');
        document.getElementById('subCategory').value = book.subCategory;
        document.getElementById('buyStatus').value = book.buyStatus;
        document.getElementById('language').value = book.language;
        document.getElementById('format').value = book.format.join(', ');
        document.getElementById('ePlatform').value = book.ePlatform;
        
        let numericVol = parseInt(book.volume) || 1;
        document.getElementById('volume').value = numericVol;
        document.getElementById('volumeUnit').value = book.volumeUnit;
        document.getElementById('hasPrologue').checked = book.hasPrologue;
        document.getElementById('isSingleVolume').checked = book.volume.toString().includes('å…¨');
        
        document.getElementById('workStatus').value = book.workStatus;
        document.getElementById('readProgress').value = book.readProgress;
        document.getElementById('tags').value = book.tags.join(', ');
        document.getElementById('relationId').value = book.relationId;
        document.getElementById('notes').value = book.notes;
        document.getElementById('review').value = book.review || '';
        document.getElementById('publisher').value = book.publisher || '';
        document.getElementById('serialPlatform').value = book.serialPlatform || '';
        document.getElementById('rating').value = book.rating;
        document.getElementById('canDiscard').checked = book.canDiscard;
        document.getElementById('willHide').checked = book.willHide;
        document.getElementById('reRead').value = book.reRead;
        document.getElementById('isAudioDrama').checked = book.isAudioDrama;
        handleRatingChange(document.getElementById('rating'));

        const relatedBooks = allBooks.filter(b => b.title === book.title);
        if (relatedBooks.length > 1) { 
            applyVersionLock(); 
            document.getElementById('syncUnlockBtn').style.display = 'block'; 
        } 
        else { 
            document.querySelectorAll('.locked-field').forEach(el => el.classList.remove('locked-field')); 
            document.getElementById('syncUnlockBtn').style.display = 'none'; 
        }
        document.getElementById('saveBtn').style.display = 'none';
        document.getElementById('updateBtn').style.display = 'block';
        document.getElementById('cancelBtn').style.display = 'block';
        document.getElementById('multiVersionBtn').style.display = 'block';
    }

    function applyVersionLock() {
        const lockFields = ['title', 'nationality', 'relationId', 'workStatus', 'tags', 'rating', 'reRead', 'isAudioDrama', 'willHide', 'review'];
        lockFields.forEach(id => document.getElementById(id).classList.add('locked-field'));
        const unlockIds = ['author', 'bookCategory', 'publisher', 'serialPlatform'];
        unlockIds.forEach(id => document.getElementById(id).classList.remove('locked-field'));
        document.querySelectorAll('input[name="typeCheck"]').forEach(cb => cb.disabled = false);
    }

    function unlockForSync() {
        if(!confirm("ç¢ºå®šåŒæ­¥æ›´æ–°æ‰€æœ‰ç‰ˆæœ¬ï¼Ÿ")) return;
        document.querySelectorAll('.locked-field').forEach(el => el.classList.remove('locked-field'));
        document.querySelectorAll('input[name="typeCheck"]').forEach(cb => cb.disabled = false);
        isSyncMode = true; document.getElementById('syncUnlockBtn').style.display = 'none';
        document.getElementById('updateBtn').innerText = "åŒæ­¥æ›´æ–°æ‰€æœ‰ç‰ˆæœ¬è³‡è¨Š";
    }

    function toggleMultiVersion() {
        if (!editingTarget) return; 
        applyVersionLock();
        document.getElementById('saveBtn').style.display = 'block';
        document.getElementById('saveBtn').innerText = "å„²å­˜ç‚ºæ–°ç‰ˆæœ¬";
        document.getElementById('updateBtn').style.display = 'none';
        document.getElementById('multiVersionBtn').style.display = 'none';
        document.getElementById('syncUnlockBtn').style.display = 'none';
        editingTarget = null;
    }

    function resetForm() {
        document.getElementById('inputForm').querySelectorAll('input, select, textarea').forEach(el => { el.value = ''; el.classList.remove('locked-field'); el.disabled = false; });
        document.querySelectorAll('input[name="typeCheck"]').forEach(cb => {cb.checked = false; cb.disabled = false;});
        document.querySelectorAll('input[name="authorRole"]').forEach(cb => {cb.checked = false;});
        document.getElementById('isSingleVolume').checked = false; document.getElementById('canDiscard').checked = false;
        document.getElementById('willHide').checked = false; document.getElementById('isAudioDrama').checked = false; 
        document.getElementById('hasPrologue').checked = false;
        document.getElementById('volumeUnit').selectedIndex = 0;
        document.getElementById('discardZone').style.display = 'none';
        document.getElementById('saveBtn').style.display = 'block'; document.getElementById('saveBtn').innerText = "å„²å­˜æ›¸å–®è‡³é›²ç«¯";
        document.getElementById('updateBtn').style.display = 'none'; document.getElementById('updateBtn').innerText = "æ›´æ–°æ­¤ç‰ˆæœ¬è³‡è¨Š";
        document.getElementById('cancelBtn').style.display = 'none'; document.getElementById('multiVersionBtn').style.display = 'block';
        document.getElementById('syncUnlockBtn').style.display = 'none'; editingTarget = null; isSyncMode = false;
    }

    function toggleReview(btn) {
        const content = btn.nextElementSibling;
        const isHidden = content.style.display === 'none' || content.style.display === '';
        content.style.display = isHidden ? 'block' : 'none';
        btn.innerText = isHidden ? 'ğŸ”¼ æ”¶èµ·å¿ƒå¾—' : 'ğŸ“ æŸ¥çœ‹å¿ƒå¾—';
    }

    function updateDatalists() {
        const getU = (key) => [...new Set(allBooks.map(b => b[key]))].filter(v => v && v !== '-').sort();
        const getSplitU = (key) => {
            let set = new Set();
            allBooks.forEach(b => {
                let val = b[key];
                if (Array.isArray(val)) { val.forEach(v => set.add(v.trim())); } 
                else if (typeof val === 'string' && val.trim() !== '') {
                    val.split(/[ï¼Œ,]/).forEach(v => { const trimmed = v.trim(); if (trimmed) set.add(trimmed); });
                }
            });
            return [...set].sort();
        };
        const fill = (id, list) => { const el = document.getElementById(id); if (el) el.innerHTML = list.map(v => `<option value="${v}">`).join(''); };
        fill('authorList', getU('author')); fill('natList', getU('nationality')); 
        fill('catList', getSplitU('bookCategory')); fill('subCatList', getSplitU('subCategory')); 
        fill('langList', getU('language')); fill('formatList', getSplitU('format')); 
        fill('platformList', getSplitU('ePlatform'));
        fill('workStatusList', getU('workStatus')); fill('readList', getU('readProgress')); 
        fill('tagOptionList', getSplitU('tags')); fill('publisherList', getU('publisher')); 
        fill('serialPlatformList', getSplitU('serialPlatform')); fill('relationIdList', getU('relationId'));
    }

    function applyFilters(isManual = true) {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const starTerm = document.getElementById('ratingFilter').value;
        let filtered = allBooks;
        if (!currentFilter.key && !searchTerm && !starTerm && !isManual) { document.getElementById('contentSection').style.display = 'none'; updateStats(); return; }
        if (starTerm) filtered = filtered.filter(b => b.rating.toString() === starTerm);
        if (currentFilter.key === 'é¡å‹') filtered = filtered.filter(b => b.bookCategory.split(/[ï¼Œ,]/).map(s=>s.trim()).includes(currentFilter.value));
        if (currentFilter.key === 'ä½œè€…') filtered = filtered.filter(b => b.author === currentFilter.value);
        if (currentFilter.key === 'ä½ç½®') filtered = filtered.filter(b => b.ePlatform.split(/[ï¼Œ,]/).map(s=>s.trim()).includes(currentFilter.value));
        if (currentFilter.key === 'å½¢å¼') filtered = filtered.filter(b => b.format.includes(currentFilter.value));
        if (currentFilter.key === 'è³¼è²·ç‹€æ…‹') filtered = filtered.filter(b => b.buyStatus === currentFilter.value);
        if (currentFilter.key === 'é–±è®€ç‹€æ…‹') filtered = filtered.filter(b => b.readProgress === currentFilter.value);
        if (currentFilter.key === 'é—œè¯IP') filtered = filtered.filter(b => b.relationId === currentFilter.value);
        if (currentFilter.key === 'å‡ºç‰ˆç¤¾') filtered = filtered.filter(b => b.publisher === currentFilter.value);
        if (currentFilter.key === 'é€£è¼‰å¹³å°') filtered = filtered.filter(b => b.serialPlatform.split(/[ï¼Œ,]/).map(s=>s.trim()).includes(currentFilter.value));
        if (secondFilter) {
            filtered = filtered.filter(b => {
                const subCats = b.subCategory ? b.subCategory.split(/[ï¼Œ,]/).map(s=>s.trim()) : [];
                const tags = Array.isArray(b.tags) ? b.tags : (b.tags ? b.tags.split(/[ï¼Œ,]/).map(s=>s.trim()) : []);
                return subCats.includes(secondFilter) || tags.includes(secondFilter);
            });
        }
        if (searchTerm) filtered = filtered.filter(b => b.title.toLowerCase().includes(searchTerm) || b.author.toLowerCase().includes(searchTerm) || b.notes.toLowerCase().includes(searchTerm) || (b.review && b.review.toLowerCase().includes(searchTerm)));
        const groups = []; filtered.forEach(b => { const k = b.title; let g = groups.find(x => x.key === k); if (!g) { g = { key: k, books: [] }; groups.push(g); } g.books.push(b); });
        currentFilteredGroups = groups;
        document.getElementById('contentSection').style.display = 'block';
        renderTable(); updateCategoryButtons(); updateSubFilterButtons(); updateStats(); 
        if (isManual && (starTerm || currentFilter.key || secondFilter)) {
            setTimeout(() => {
                const target = document.getElementById('contentSection');
                if(target) window.scrollTo({ top: target.offsetTop - 50, behavior: 'smooth' });
            }, 100);
        }
    }

    function updateStats() {
        const p = document.getElementById('statsPanel'); if (!p || allBooks.length === 0) return;
        const cc = {}; allBooks.forEach(b => b.bookCategory.split(/[ï¼Œ,]/).forEach(c => cc[c.trim()] = (cc[c.trim()] || 0) + 1));
        let catStr = ""; Object.keys(cc).sort().forEach(c => catStr += `${c}(${cc[c]}) `);
        p.innerHTML = `<div class="stats-item">ç¸½åœ–æ›¸é‡ï¼š<strong>${allBooks.length}</strong> æœ¬</div><div class="stats-item">æ›¸ç±é¡å‹çµ±è¨ˆï¼š<strong>${catStr.trim()}</strong></div>`;
    }

    function renderTable() {
        const tbody = document.getElementById('bookTableBody'); tbody.innerHTML = '';
        const start = (currentPage - 1) * itemsPerPage;
        const pageGroups = currentFilteredGroups.slice(start, start + itemsPerPage);
        pageGroups.forEach(group => {
            let groupHtml = `<div class="group-row-container">`;
            group.books.forEach((book, idx) => {
                const isFirst = idx === 0;
                let natDisplay = book.nationality && book.nationality.trim() !== "" ? ` (${book.nationality})` : "";
                let roleDisplay = book.authorRole ? ` [${book.authorRole.replace(',', '/')}]` : "";
                const authorDisplay = `${book.author}${roleDisplay}${natDisplay}`;
                const params = `'${book.title.replace(/'/g, "\\'")}', '${book.language}', '${book.format.join(',')}'`;
                const versionHeader = group.books.length > 1 ? `<div class="pill-multi-version">ç‰ˆæœ¬ ${idx+1}</div>` : '';
                
                let volText = "";
                if(book.volume.toString().includes('å…¨')) { volText = 'å…¨ä¸€é›†'; } 
                else {
                    let num = parseInt(book.volume) || 0;
                    let unit = book.volumeUnit || "é›†";
                    let proSuffix = book.hasPrologue ? "å«åºç« " : "";
                    let displayNum = book.hasPrologue ? (num + 1) : num;
                    volText = `å…± ${displayNum} ${unit.replace('(è©±)','')}${proSuffix}`;
                }

                const alertKeywords = ['å‘', 'æœª', 'æ²’', 'ä¸'];
                const workStatusStyle = alertKeywords.some(k => book.workStatus.includes(k)) ? 'color:#dc3545; font-weight:bold;' : '';
                const buyStatusHtml = `<div style="margin-bottom:5px;">${volText} (<span style="${workStatusStyle}">${book.workStatus}</span>)</div><span class="${getPillClass(book.buyStatus, 'status')}" onclick="setFilter('è³¼è²·ç‹€æ…‹','${book.buyStatus}')">${book.buyStatus}</span>`;

                let ratingStars = "â­".repeat(parseInt(book.rating) || 0);
                let reReadText = book.reRead;
                if(!reReadText || reReadText === 'æœªè¨­å®š' || reReadText.trim() === '') {
                    reReadText = `<span style="color:#FFAAD5; font-weight:bold;">å¾…è£œ</span>`;
                } else { reReadText = `(${reReadText})`; }

                let evalDisplay = `<div style="margin-bottom:5px;">${ratingStars}</div><div>${reReadText}</div>`;
                if (book.canDiscard) evalDisplay += `<div style="color:#dc3545; font-size:11px; font-weight:bold; margin-top:5px;">ã€å¯è³£æ‰/ä¸Ÿæ‰ã€‘</div>`;
                if (book.willHide) evalDisplay += `<div style="color:#dc3545; font-size:11px; font-weight:bold; margin-top:2px;">ã€æƒ³éš±è—ã€‘</div>`;

                const actionHtml = `<div class="action-btns"><button class="btn-edit-small" onclick="editBook(${params})">ä¿®æ”¹</button><button class="btn-del-small" onclick="deleteBook(${params})">åˆªé™¤</button></div>`;
                const titleContentHtml = `<div class="mobile-title-row"><div>${versionHeader}<br><strong style="color:#28a745; cursor:pointer" onclick="editBook(${params})">${book.title}</strong><br><small style="color:#007bff; cursor:pointer;" onclick="setFilter('ä½œè€…','${book.author}')">${authorDisplay}</small></div>${actionHtml}</div>`;

                groupHtml += `<tr><td data-label="æ›¸å/ä½œè€…">${titleContentHtml}</td><td data-label="é–±è®€ç‹€æ…‹"><span class="${getPillClass(book.readProgress, 'status')}" onclick="setFilter('é–±è®€ç‹€æ…‹','${book.readProgress}')">${book.readProgress}</span></td><td data-label="æ›¸ç±ä½ç½®">${book.ePlatform.split(/[ï¼Œ,]/).map(loc => `<span class="${getPillClass(loc.trim(), 'location')}" onclick="setFilter('ä½ç½®','${loc.trim()}')">${loc.trim()}</span>`).join(' ')}</td><td data-label="å½¢å¼"><div>${book.language}</div>${book.format.map(f => `<span class="tag-pill" onclick="setFilter('å½¢å¼','${f}')">${f}</span>`).join('')}</td><td data-label="è³¼è²·ç‹€æ³">${buyStatusHtml}</td><td data-label="è©•åƒ¹/é‡çœ‹">${evalDisplay}</td>`;

                if (isFirst) {
                    let tagHtml = '';
                    if(book.publisher) tagHtml += `<span class="${getPillClass(book.publisher, 'publisher')}" onclick="setFilter('å‡ºç‰ˆç¤¾','${book.publisher}')">${book.publisher}</span>`;
                    if(book.serialPlatform) {
                        book.serialPlatform.split(/[ï¼Œ,]/).forEach(sp => {
                            const pName = sp.trim();
                            const pClass = getPillClass(pName, book.isAudioDrama ? 'drama' : 'serial');
                            tagHtml += `<span class="${pClass}" onclick="setFilter('é€£è¼‰å¹³å°','${pName}')">${pName}</span>`;
                        });
                    }
                    book.bookCategory.split(/[ï¼Œ,]/).forEach(c => { tagHtml += `<span class="${getPillClass(c.trim(), 'main')}" onclick="setFilter('é¡å‹','${c.trim()}')">${c.trim()}</span>`; });
                    if(book.subCategory) {
                        book.subCategory.split(/[ï¼Œ,]/).forEach(s => { tagHtml += `<span class="${getPillClass(s.trim(), 'category')}" onclick="setFilter('å°æ¨™ç±¤','${s.trim()}')">${s.trim()}</span>`; });
                    }
                    book.tags.forEach(t => { tagHtml += `<span class="${getPillClass(t, 'sub')}" onclick="setFilter('å°æ¨™ç±¤','${t}')">${t}</span>`; });
                    if(book.relationId) { tagHtml += `<span class="${getPillClass(book.relationId, 'relation')}" onclick="setFilter('é—œè¯IP','${book.relationId}')">${book.relationId}</span>`; }
                    
                    // åˆ†é–‹é¡¯ç¤ºå‚™è¨»èˆ‡å¿ƒå¾—
                    let notesHtml = `<div class="notes-box">${book.notes || '-'}</div>`;
                    let reviewHtml = '';
                    if(book.review && book.review.trim() !== "") {
                        reviewHtml = `
                            <div>
                                <button class="review-toggle-btn" onclick="toggleReview(this)">ğŸ“ æŸ¥çœ‹å¿ƒå¾—</button>
                                <div class="review-content">${book.review}</div>
                            </div>
                        `;
                    }

                    groupHtml += `<td data-label="æ¨™ç±¤">${tagHtml}</td><td data-label="å‚™è¨»/å¿ƒå¾—" class="notes-column">${notesHtml}${reviewHtml}</td>`;
                } else { groupHtml += `<td class="pc-only"></td><td class="pc-only"></td>`; }
                groupHtml += `</tr>`;
            });
            groupHtml += `</div>`; tbody.innerHTML += groupHtml;
        });
        renderPagination();
    }

    function clearFilter() { currentFilter = { key: null, value: null }; secondFilter = null; document.getElementById('searchInput').value = ''; document.getElementById('ratingFilter').value = ""; document.getElementById('contentSection').style.display = 'none'; updateCategoryButtons(); updateSubFilterButtons(); updateStats(); window.scrollTo({ top: 0, behavior: 'smooth' }); }
    function setFilter(key, value) { if (key === 'ä½œè€…') { document.getElementById('searchInput').value = value; applyFilters(true); return; } if (key === 'SHOW_ALL') { document.getElementById('searchInput').value = ''; document.getElementById('ratingFilter').value = ""; currentFilter = { key: null, value: null }; secondFilter = null; applyFilters(true); return; } currentFilter = { key, value }; secondFilter = null; currentPage = 1; applyFilters(true); }
    function updateCategoryButtons() { const p = document.getElementById('categoryPanel'); const catsSet = new Set(); allBooks.forEach(b => b.bookCategory.split(/[ï¼Œ,]/).forEach(c => catsSet.add(c.trim()))); const cats = Array.from(catsSet).sort(); p.innerHTML = `<button class="cat-btn ${!currentFilter.key ? 'active' : ''}" onclick="setFilter('SHOW_ALL', null)">ğŸ“‚ é¡¯ç¤ºå…¨éƒ¨</button>`; cats.forEach(c => { p.innerHTML += `<button class="cat-btn ${currentFilter.value === c ? 'active' : ''}" onclick="setFilter('é¡å‹','${c}')">${c}</button>`; }); }
    function updateSubFilterButtons() { const panel = document.getElementById('subFilterPanel'); if (currentFilter.key !== 'é¡å‹') { panel.style.display = 'none'; return; } let subCatsSet = new Set(), tagsSet = new Set(); allBooks.filter(b => b.bookCategory.split(/[ï¼Œ,]/).map(s=>s.trim()).includes(currentFilter.value)).forEach(b => { if (b.subCategory) b.subCategory.split(/[ï¼Œ,]/).forEach(s => subCatsSet.add(s.trim())); if (b.tags) b.tags.forEach(t => tagsSet.add(t.trim())); }); if (subCatsSet.size === 0 && tagsSet.size === 0) { panel.style.display = 'none'; return; } panel.style.display = 'flex'; panel.innerHTML = ''; if(subCatsSet.size > 0) { const row = document.createElement('div'); row.className = 'sub-filter-row'; row.innerHTML = '<div class="sub-filter-label">é€²éšç¯©é¸ï¼šæ›¸ç±é¡åˆ¥</div>'; Array.from(subCatsSet).sort().forEach(t => { const btn = document.createElement('button'); btn.className = 'sub-cat-btn' + (secondFilter === t ? ' active' : ''); btn.innerText = t; btn.onclick = () => { secondFilter = (secondFilter === t) ? null : t; applyFilters(true); }; row.appendChild(btn); }); panel.appendChild(row); } if(tagsSet.size > 0) { const row = document.createElement('div'); row.className = 'sub-filter-row'; row.innerHTML = '<div class="sub-filter-label">é€²éšç¯©é¸ï¼šæ¨™ç±¤</div>'; Array.from(tagsSet).sort().forEach(t => { const btn = document.createElement('button'); btn.className = 'sub-cat-btn' + (secondFilter === t ? ' active' : ''); btn.innerText = t; btn.onclick = () => { secondFilter = (secondFilter === t) ? null : t; applyFilters(true); }; row.appendChild(btn); }); panel.appendChild(row); } }
    function renderPagination() { const totalPages = Math.ceil(currentFilteredGroups.length / itemsPerPage); const container = document.getElementById('pagination'); container.innerHTML = ''; if (totalPages <= 1) return; for (let i = 1; i <= totalPages; i++) { const btn = document.createElement('button'); btn.innerText = i; btn.className = `page-btn ${i === currentPage ? 'active' : ''}`; btn.onclick = () => { currentPage = i; renderTable(); window.scrollTo({ top: document.getElementById('contentSection').offsetTop - 50, behavior: 'smooth' }); }; container.appendChild(btn); } }
    function handleSingleVolume(cb) { const v = document.getElementById('volume'); const u = document.getElementById('volumeUnit'); const p = document.getElementById('hasPrologue'); v.disabled = cb.checked; u.disabled = cb.checked; p.disabled = cb.checked; if (cb.checked) v.value = 1; }
    async function deleteBook(t, l, f) { if (!confirm(`ç¢ºå®šåˆªé™¤ï¼Ÿ`)) return; document.getElementById('loading').style.display='flex'; try { await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', title: t, language: l, format: f }) }); await loadFromCloud(); } catch (e) { alert("åˆªé™¤å¤±æ•—"); } document.getElementById('loading').style.display='none'; }
    loadFromCloud();
</script>

</body>
</html>
